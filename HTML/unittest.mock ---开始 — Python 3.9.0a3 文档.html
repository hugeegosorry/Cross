<!DOCTYPE html> <html xmlns=http://www.w3.org/1999/xhtml lang=zh><!--
 Page saved with SingleFile 
 url: https://www.osgeo.cn/cpython/library/unittest.mock-examples.html 
 saved date: Sun May 17 2020 20:48:09 GMT+0800 (中国标准时间)
--><meta charset=utf-8>
<title>unittest.mock ---开始 — Python 3.9.0a3 文档</title>
<style>div.body{min-width:450px;max-width:800px}div.body p,div.body dd,div.body li{-moz-hyphens:auto;-ms-hyphens:auto;-webkit-hyphens:auto}a.headerlink{visibility:hidden}a.brackets:before,span.brackets>a:before{content:"["}a.brackets:after,span.brackets>a:after{content:"]"}h1:hover>a.headerlink,h2:hover>a.headerlink,h3:hover>a.headerlink,h4:hover>a.headerlink,h5:hover>a.headerlink,h6:hover>a.headerlink,dt:hover>a.headerlink,caption:hover>a.headerlink,p.caption:hover>a.headerlink,div.code-block-caption:hover>a.headerlink{visibility:visible}div.admonition{margin-top:10px;margin-bottom:10px;padding:7px}p.admonition-title{margin:0px 10px 5px 0px;font-weight:bold}li>p:first-child{margin-top:0px}li>p:last-child{margin-bottom:0px}dl.footnote>dt{float:left}dl.footnote>dd{margin-bottom:0em}dl.footnote>dd:after,dl.citation>dd:after{content:"";clear:both}dl{margin-bottom:15px}dd>p:first-child{margin-top:0px}dd{margin-top:3px;margin-left:30px}dt:target,span.highlighted{background-color:#fbe54e}.versionmodified{font-style:italic}.footnote:target{background-color:#ffa}pre{overflow:auto;overflow-y:hidden}span.pre{-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;hyphens:none}code.xref{background-color:transparent}html{background-color:#fff}body{font-family:'Lucida Grande',Arial,sans-serif;font-size:100%;color:#000;margin:0;padding:0}div.document{background-color:white}div.documentwrapper{float:left;width:100%}div.bodywrapper{margin:0 0 0 230px}div.body{background-color:white;color:#222}a{text-decoration:none}a:visited{color:#00608f;text-decoration:none}a:hover{text-decoration:underline}div.body h1,div.body h2,div.body h3{font-family:'Lucida Grande',Arial,sans-serif;background-color:white;font-weight:normal;color:#1a1a1a;border-bottom:1px solid #ccc}div.body h1{margin-top:0;font-size:200%}div.body h2{font-size:160%}div.body h3{font-size:140%}a.headerlink{font-size:.8em;padding:0 4px 0 4px;text-decoration:none}a.headerlink:hover{background-color:#aaa;color:white}div.body p,div.body dd,div.body li{text-align:justify;line-height:130%}div.admonition p.admonition-title+p{display:inline}div.admonition p{margin-bottom:5px}div.admonition pre{margin-bottom:5px}div.note{background-color:#eee;border:1px solid #ccc}p.admonition-title{display:inline}p.admonition-title:after{content:":"}pre{padding:5px;background-color:#efc;color:#333;line-height:120%;border-left:0;border-right:0}code{background-color:#ecf0f3;padding:0 1px 0 1px}.note code{background:#d6d6d6}body{background-color:white;margin-left:1em;margin-right:1em}div.body{padding:0 0 0 1.2em}div.body p{line-height:140%}div.body h1,div.body h2,div.body h3{margin:0;border:0;padding:.3em 0}div.body pre{border-radius:3px;border:1px solid #ac9}div.body div.admonition{border-radius:3px}div.body a{color:#0072aa}div.body a:visited{color:#6363bb}div.body a:hover{color:#00b0e4}code,pre{font-family:monospace,sans-serif;font-size:96.5%}div.body code{border-radius:3px}div.body code.xref{font-weight:normal}.highlight{background:none!important}.highlight{background:#efc}.highlight .c{color:#408090;font-style:italic}.highlight .k{color:#007020;font-weight:bold}.highlight .o{color:#666}.highlight .c1{color:#408090;font-style:italic}.highlight .gr{color:red}.highlight .go{color:#333}.highlight .gp{color:#c65d09;font-weight:bold}.highlight .gt{color:#04d}.highlight .kc{color:#007020;font-weight:bold}.highlight .kn{color:#007020;font-weight:bold}.highlight .nb{color:#007020}.highlight .nc{color:#0e84b5;font-weight:bold}.highlight .nd{color:#555;font-weight:bold}.highlight .ne{color:#007020}.highlight .nf{color:#06287e}.highlight .nn{color:#0e84b5;font-weight:bold}.highlight .ow{color:#007020;font-weight:bold}.highlight .mi{color:#208050}.highlight .s2{color:#4070a0}.highlight .s1{color:#4070a0}.highlight .bp{color:#007020}.highlight .fm{color:#06287e}</style>
<link rel=search type=application/opensearchdescription+xml title="在 Python 3.9.0a3 文档 中搜索" href=https://www.osgeo.cn/cpython/_static/opensearch.xml>
<link rel=author title=关于这些文档 href=https://www.osgeo.cn/cpython/about.html>
<link rel=index title=索引 href=https://www.osgeo.cn/cpython/genindex.html>
<link rel=search title=搜索 href=https://www.osgeo.cn/cpython/search.html>
<link rel=copyright title=版权所有 href=https://www.osgeo.cn/cpython/copyright.html>
<link rel=next title="2to 3-自动python 2到3代码转换" href=https://www.osgeo.cn/cpython/library/2to3.html>
<link rel=prev title="unittest.mock ---模拟对象库" href=https://www.osgeo.cn/cpython/library/unittest.mock.html>
<link rel=canonical href=https://docs.python.org/3/library/unittest.mock-examples.html>
<style>@media (pointer:coarse){@media only screen and (max-device-width:1024px){html{font-size:80%!important}}@media only screen and (max-device-width:414px){html{font-size:70%!important}}@media only screen and (max-device-width:320px){html{font-size:90%!important}}}@-webkit-keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@keyframes srFadeInUp{0%{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}to{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}}@-webkit-keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@keyframes srFadeInDown{0%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}to{opacity:0;-webkit-transform:translateY(100px);transform:translateY(100px)}}@-webkit-keyframes fadeOutUp{0%{opacity:1}to{margin-top:0;padding:0;height:0;min-height:0;opacity:0;-webkit-transform:scaleY(0);transform:scaleY(0)}}@keyframes fadeOutUp{0%{opacity:1}to{margin-top:0;padding:0;height:0;min-height:0;opacity:0;-webkit-transform:scaleY(0);transform:scaleY(0)}}@keyframes caretBlink{from{opacity:1.0}to{opacity:0.0}}@keyframes rotateSpinner{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style><link rel="shortcut icon" type=image/png href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAAXNSR0IArs4c6QAAAAZiS0dEAP8A/wD/oL2nkwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAAd0SU1FB9gEGxE4IQYzJ14AAAI3SURBVDjLZZNPSFVBFIe/e9+zd3silBCl0SZoU4s2rVq0EB5tQip4UNvATVGu3QRBiyAi2iltWkgbF5EgRhFFRpiWtrWIzDIV1Pzz7p15M2fmtvDevOqBw8DM9zvnN8ycgF3R/eDtM2mac96ZdrFNxBikqbRV+vHH/ut9gAZczoe7C3gnF0f6au1OLM5avFi8d1Ea+JvAMSAq8nsKOGs5f2cYJ3Y7rc2PO4BqkS8DdD98f9tbe1ysCoxOBo1qlEXHJWcM4b5KPU19zleA0o4Clx99eO3EdqVewHsCoFRugUoVghJO7A6H6Vx9wdtYi27cr5x6dy/03nVtWTU7bWeZh6jNUcAiCaFTURl9A+gs56AviHzh3mnqtdPxm6knfQPLU7UaokASQq/agY7yDrG16Mba6Pz48NP56VdrgAApYObGaicPtkovToFLQBKA/WUxTe3FRk4san15aGKgd3Dj560rrdGJS6FT0X9YYvLuiMKL1kAQOpHZ3PqfyZfP41+9PW1VfzX0RXFSECfgNEmSTgImdDruF2O0E8vvqZG1auQubAsKooIYYHpGvwA2g+xndQBHgWa6cG0ih5cW/w6VvEq3nChwCoBvs+bL2Z7VceBHGTDAIrABpMVuhw+4OiLgLIglOLPYBTQAlfErIeCzjRVg1dtEb1kt5Omv+DTV2YssAN+zNdkzC42N9brV8WdvYp07seOdM2Of1F3AAknW0AJpwN6IgEPAEaANaMlcbmZdl7KRBuAfAb+v//yMAJoAAAAASUVORK5CYII="><style>.sf-hidden{display:none!important}</style><body>
 
 <div class=related role=navigation aria-label="related navigation" style=display:none!important>
 
 
 </div> 
 <div class=document>
 <div class=documentwrapper>
 <div class=bodywrapper>
 <div class=body role=main>
 
 <div class=section id=unittest-mock-getting-started>
<h1><a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#module-unittest.mock title="unittest.mock: Mock object library."><code class="xref py py-mod docutils literal notranslate"><span class=pre>unittest.mock</span></code></a> ---开始<a class=headerlink href=#unittest-mock-getting-started title=永久链接至标题>¶</a></h1>
<div class=versionadded>
<p><span class="versionmodified added">3.3 新版功能.</span></p>
</div>
<span class=target id=getting-started></span><div class=section id=using-mock>
<h2>使用模拟<a class=headerlink href=#using-mock title=永久链接至标题>¶</a></h2>
<div class=section id=mock-patching-methods>
<h3>模拟修补方法<a class=headerlink href=#mock-patching-methods title=永久链接至标题>¶</a></h3>
<p>常用用途 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock title=unittest.mock.Mock><code class="xref py py-class docutils literal notranslate"><span class=pre>Mock</span></code></a> 对象包括：</p>
<ins class="adsbygoogle sf-hidden" style=display:block;text-align:center data-ad-layout=in-article data-ad-format=fluid data-ad-client=ca-pub-1466963416408457 data-ad-slot=8850786025></ins>
<ul class=simple>
<li><p>修补方法</p></li>
<li><p>记录对对象的方法调用</p></li>
</ul>
<p>您可能希望替换对象上的方法，以检查系统的另一部分是否使用正确的参数调用了该方法：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>real</span> <span class=o>=</span> <span class=n>SomeClass</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>real</span><span class=o>.</span><span class=n>method</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>'method'</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>real</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=n>key</span><span class=o>=</span><span class=s1>'value'</span><span class=p>)</span>
<span class=go>&lt;MagicMock name='method()' id='...'&gt;</span>
</pre></div>
</div>
<p>一旦我们的模型被使用 (<code class="docutils literal notranslate"><span class=pre>real.method</span></code> 在本例中）它有方法和属性，允许您对它的使用方式进行断言。</p>
<div class="admonition note">
<p class=admonition-title>注解</p>
<p>在这些例子中， <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock title=unittest.mock.Mock><code class="xref py py-class docutils literal notranslate"><span class=pre>Mock</span></code></a> 和 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.MagicMock title=unittest.mock.MagicMock><code class="xref py py-class docutils literal notranslate"><span class=pre>MagicMock</span></code></a> 类是可互换的。作为 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 默认情况下，它是一个更有用的类。</p>
</div>
<p>一旦模型被称为 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.called title=unittest.mock.Mock.called><code class="xref py py-attr docutils literal notranslate"><span class=pre>called</span></code></a> 属性设置为 <code class="docutils literal notranslate"><span class=pre>True</span></code> .更重要的是我们可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.assert_called_with title=unittest.mock.Mock.assert_called_with><code class="xref py py-meth docutils literal notranslate"><span class=pre>assert_called_with()</span></code></a> 或 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.assert_called_once_with title=unittest.mock.Mock.assert_called_once_with><code class="xref py py-meth docutils literal notranslate"><span class=pre>assert_called_once_with()</span></code></a> 方法来检查是否使用正确的参数调用了它。</p>
<p>此示例测试调用 <code class="docutils literal notranslate"><span class=pre>ProductionClass().method</span></code> 结果调用了 <code class="docutils literal notranslate"><span class=pre>something</span></code> 方法：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>ProductionClass</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>method</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>something</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>something</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>pass</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>real</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>real</span><span class=o>.</span><span class=n>something</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>real</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>real</span><span class=o>.</span><span class=n>something</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</pre></div>
</div>
</div>
<div class=section id=mock-for-method-calls-on-an-object>
<h3>模拟对象上的方法调用<a class=headerlink href=#mock-for-method-calls-on-an-object title=永久链接至标题>¶</a></h3>
<p>在上一个示例中，我们直接在对象上修补了一个方法，以检查是否正确调用了该方法。另一个常见的用例是将一个对象传递到一个方法（或被测试系统的某个部分）中，然后检查它是否以正确的方式使用。</p>
<p>简单的 <code class="docutils literal notranslate"><span class=pre>ProductionClass</span></code> 下面有一个 <code class="docutils literal notranslate"><span class=pre>closer</span></code> 方法。如果用对象调用它，则它调用 <code class="docutils literal notranslate"><span class=pre>close</span></code> 关于它。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>ProductionClass</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>closer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>something</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>something</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
<span class=gp>...</span>
</pre></div>
</div>
<p>所以为了测试它，我们需要通过一个对象 <code class="docutils literal notranslate"><span class=pre>close</span></code> 方法并检查是否正确调用了它。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>real</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>real</span><span class=o>.</span><span class=n>closer</span><span class=p>(</span><span class=n>mock</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>close</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>()</span>
</pre></div>
</div>
<p>我们不需要做任何工作来在我们的模型上提供“关闭”方法。访问close将创建它。因此，如果尚未调用“close”，那么在测试中访问它将创建它，但是 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.assert_called_with title=unittest.mock.Mock.assert_called_with><code class="xref py py-meth docutils literal notranslate"><span class=pre>assert_called_with()</span></code></a> 将引发失败异常。</p>
</div>
<div class=section id=mocking-classes>
<h3>嘲弄课<a class=headerlink href=#mocking-classes title=永久链接至标题>¶</a></h3>
<p>一个常见的用例是模拟被测试代码实例化的类。当您修补一个类时，该类将替换为模拟类。实例由创建 <em>给类调用</em> . 这意味着您通过查看模拟类的返回值来访问“模拟实例”。</p>
<p>在下面的示例中，我们有一个函数 <code class="docutils literal notranslate"><span class=pre>some_function</span></code> 例示 <code class="docutils literal notranslate"><span class=pre>Foo</span></code> 并对其调用方法。呼唤 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> 替换类 <code class="docutils literal notranslate"><span class=pre>Foo</span></code> 嘲弄地模仿这个 <code class="docutils literal notranslate"><span class=pre>Foo</span></code> 实例是调用模拟的结果，因此通过修改模拟来配置它。 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.return_value title=unittest.mock.Mock.return_value><code class="xref py py-attr docutils literal notranslate"><span class=pre>return_value</span></code></a> . ：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>some_function</span><span class=p>():</span>
<span class=gp>... </span>    <span class=n>instance</span> <span class=o>=</span> <span class=n>module</span><span class=o>.</span><span class=n>Foo</span><span class=p>()</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>instance</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'module.Foo'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>instance</span> <span class=o>=</span> <span class=n>mock</span><span class=o>.</span><span class=n>return_value</span>
<span class=gp>... </span>    <span class=n>instance</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s1>'the result'</span>
<span class=gp>... </span>    <span class=n>result</span> <span class=o>=</span> <span class=n>some_function</span><span class=p>()</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>result</span> <span class=o>==</span> <span class=s1>'the result'</span>
</pre></div>
</div>
</div>
<div class=section id=naming-your-mocks>
<h3>给你的模型命名<a class=headerlink href=#naming-your-mocks title=永久链接至标题>¶</a></h3>
<p>给你的模型起个名字是很有用的。该名称显示在模拟的repr中，当模拟出现在测试失败消息中时，该名称会很有帮助。该名称还传播到mock的属性或方法：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>'foo'</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span>
<span class=go>&lt;MagicMock name='foo' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>method</span>
<span class=go>&lt;MagicMock name='foo.method' id='...'&gt;</span>
</pre></div>
</div>
</div>
<div class=section id=tracking-all-calls>
<h3>跟踪所有调用<a class=headerlink href=#tracking-all-calls title=永久链接至标题>¶</a></h3>
<p>通常您希望跟踪一个方法的多个调用。这个 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.mock_calls title=unittest.mock.Mock.mock_calls><code class="xref py py-attr docutils literal notranslate"><span class=pre>mock_calls</span></code></a> 属性记录对模拟的子属性以及对其子属性的所有调用。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
<span class=go>&lt;MagicMock name='mock.method()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>attribute</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=mi>53</span><span class=p>)</span>
<span class=go>&lt;MagicMock name='mock.attribute.method()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span>
<span class=go>[call.method(), call.attribute.method(10, x=53)]</span>
</pre></div>
</div>
<p>如果你断言 <code class="docutils literal notranslate"><span class=pre>mock_calls</span></code> 如果调用了任何意外的方法，则断言将失败。这很有用，因为除了断言您期望的调用已经发出之外，您还检查它们是否按正确的顺序发出，并且没有其他调用：</p>
<p>你使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.call title=unittest.mock.call><code class="xref py py-data docutils literal notranslate"><span class=pre>call</span></code></a> 要构造用于比较的列表的对象 <code class="docutils literal notranslate"><span class=pre>mock_calls</span></code> ：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>expected</span> <span class=o>=</span> <span class=p>[</span><span class=n>call</span><span class=o>.</span><span class=n>method</span><span class=p>(),</span> <span class=n>call</span><span class=o>.</span><span class=n>attribute</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=mi>53</span><span class=p>)]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span> <span class=o>==</span> <span class=n>expected</span>
<span class=go>True</span>
</pre></div>
</div>
<p>但是，不会记录返回mock的调用的参数，这意味着在用于创建祖先的参数很重要的情况下，不可能跟踪嵌套调用：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>m</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>m</span><span class=o>.</span><span class=n>factory</span><span class=p>(</span><span class=n>important</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span><span class=o>.</span><span class=n>deliver</span><span class=p>()</span>
<span class=go>&lt;Mock name='mock.factory().deliver()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>m</span><span class=o>.</span><span class=n>mock_calls</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>call</span><span class=o>.</span><span class=n>factory</span><span class=p>(</span><span class=n>important</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=o>.</span><span class=n>deliver</span><span class=p>()</span>
<span class=go>True</span>
</pre></div>
</div>
</div>
<div class=section id=setting-return-values-and-attributes>
<h3>设置返回值和属性<a class=headerlink href=#setting-return-values-and-attributes title=永久链接至标题>¶</a></h3>
<p>在模拟对象上设置返回值非常简单：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=mi>3</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span>
<span class=go>3</span>
</pre></div>
</div>
<p>当然，您也可以对模拟上的方法执行相同的操作：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=mi>3</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
<span class=go>3</span>
</pre></div>
</div>
<p>还可以在构造函数中设置返回值：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span>
<span class=go>3</span>
</pre></div>
</div>
<p>如果您的模拟模型需要属性设置，只需执行以下操作：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>3</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>x</span>
<span class=go>3</span>
</pre></div>
</div>
<p>有时候你想模拟一个更复杂的情况，比如 <code class="docutils literal notranslate"><span class=pre>mock.connection.cursor().execute("SELECT</span> <span class=pre>1")</span></code> . 如果希望此调用返回列表，则必须配置嵌套调用的结果。</p>
<p>我们可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.call title=unittest.mock.call><code class="xref py py-data docutils literal notranslate"><span class=pre>call</span></code></a> 要在类似这样的“链接调用”中构造一组调用，以便随后进行断言：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>cursor</span> <span class=o>=</span> <span class=n>mock</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=o>.</span><span class=n>return_value</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>cursor</span><span class=o>.</span><span class=n>execute</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=p>[</span><span class=s1>'foo'</span><span class=p>]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>"SELECT 1"</span><span class=p>)</span>
<span class=go>['foo']</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>expected</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=n>connection</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>"SELECT 1"</span><span class=p>)</span><span class=o>.</span><span class=n>call_list</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span>
<span class=go>[call.connection.cursor(), call.connection.cursor().execute('SELECT 1')]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>mock_calls</span> <span class=o>==</span> <span class=n>expected</span>
<span class=go>True</span>
</pre></div>
</div>
<p>这是给 <code class="docutils literal notranslate"><span class=pre>.call_list()</span></code> 这将我们的调用对象变成一个表示链接调用的调用列表。</p>
</div>
<div class=section id=raising-exceptions-with-mocks>
<h3>通过模拟引发异常<a class=headerlink href=#raising-exceptions-with-mocks title=永久链接至标题>¶</a></h3>
<p>一个有用的属性是 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.side_effect title=unittest.mock.Mock.side_effect><code class="xref py py-attr docutils literal notranslate"><span class=pre>side_effect</span></code></a> . 如果将其设置为异常类或实例，则在调用模拟时将引发异常。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=ne>Exception</span><span class=p>(</span><span class=s1>'Boom!'</span><span class=p>))</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span>
<span class=gt>Traceback (most recent call last):</span>
  <span class=c>...</span>
<span class=gr>Exception</span><span>: </span><span class=n>Boom!</span>
</pre></div>
</div>
</div>
<div class=section id=side-effect-functions-and-iterables>
<h3>副作用函数和Iterables<a class=headerlink href=#side-effect-functions-and-iterables title=永久链接至标题>¶</a></h3>
<p><code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 也可以设置为函数或iterable。的用例 <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 作为一个iterable，您的mock将被多次调用，并且您希望每个调用返回不同的值。当你设置 <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 对于iterable，对mock的每个调用都会从iterable返回下一个值：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>])</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span>
<span class=go>4</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span>
<span class=go>5</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span>
<span class=go>6</span>
</pre></div>
</div>
<p>对于更高级的用例，比如根据mock的调用动态地改变返回值， <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 可以是函数。将使用与mock相同的参数调用函数。函数返回的是调用返回的：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>vals</span> <span class=o>=</span> <span class=p>{(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>):</span> <span class=mi>1</span><span class=p>,</span> <span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>):</span> <span class=mi>2</span><span class=p>}</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>side_effect</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>vals</span><span class=p>[</span><span class=n>args</span><span class=p>]</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=n>side_effect</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
<span class=go>1</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=go>2</span>
</pre></div>
</div>
</div>
<div class=section id=mocking-asynchronous-iterators>
<h3>模拟异步迭代器<a class=headerlink href=#mocking-asynchronous-iterators title=永久链接至标题>¶</a></h3>
<p>从Python3.8开始， <code class="docutils literal notranslate"><span class=pre>AsyncMock</span></code> 和 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 支持嘲笑 <a class="reference internal" href=https://www.osgeo.cn/cpython/reference/datamodel.html#async-iterators><span class="std std-ref">异步迭代器</span></a> 通过 <code class="docutils literal notranslate"><span class=pre>__aiter__</span></code> . 这个 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.return_value title=unittest.mock.Mock.return_value><code class="xref py py-attr docutils literal notranslate"><span class=pre>return_value</span></code></a> 属性 <code class="docutils literal notranslate"><span class=pre>__aiter__</span></code> 可用于设置要用于迭代的返回值。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>  <span class=c1># AsyncMock also works here</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__aiter__</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=p>[</span><span class=n>i</span> <span class=k>async</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>mock</span><span class=p>]</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
<span class=go>[1, 2, 3]</span>
</pre></div>
</div>
</div>
<div class=section id=mocking-asynchronous-context-manager>
<h3>模拟异步上下文管理器<a class=headerlink href=#mocking-asynchronous-context-manager title=永久链接至标题>¶</a></h3>
<p>从Python3.8开始， <code class="docutils literal notranslate"><span class=pre>AsyncMock</span></code> 和 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 支持嘲笑 <a class="reference internal" href=https://www.osgeo.cn/cpython/reference/datamodel.html#async-context-managers><span class="std std-ref">异步上下文管理器</span></a> 通过 <code class="docutils literal notranslate"><span class=pre>__aenter__</span></code> 和 <code class="docutils literal notranslate"><span class=pre>__aexit__</span></code> . 默认情况下， <code class="docutils literal notranslate"><span class=pre>__aenter__</span></code> 和 <code class="docutils literal notranslate"><span class=pre>__aexit__</span></code> 是 <code class="docutils literal notranslate"><span class=pre>AsyncMock</span></code> 返回异步函数的实例。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>AsyncContextManager</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>async</span> <span class=k>def</span> <span class=fm>__aenter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>self</span>
<span class=gp>... </span>    <span class=k>async</span> <span class=k>def</span> <span class=fm>__aexit__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exc_type</span><span class=p>,</span> <span class=n>exc</span><span class=p>,</span> <span class=n>tb</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>pass</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_instance</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>AsyncContextManager</span><span class=p>())</span>  <span class=c1># AsyncMock also works here</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>async</span> <span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
<span class=gp>... </span>    <span class=k>async</span> <span class=k>with</span> <span class=n>mock_instance</span> <span class=k>as</span> <span class=n>result</span><span class=p>:</span>
<span class=gp>... </span>        <span class=k>pass</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>asyncio</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>main</span><span class=p>())</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_instance</span><span class=o>.</span><span class=fm>__aenter__</span><span class=o>.</span><span class=n>assert_awaited_once</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_instance</span><span class=o>.</span><span class=fm>__aexit__</span><span class=o>.</span><span class=n>assert_awaited_once</span><span class=p>()</span>
</pre></div>
</div>
</div>
<div class=section id=creating-a-mock-from-an-existing-object>
<h3>从现有对象创建模拟<a class=headerlink href=#creating-a-mock-from-an-existing-object title=永久链接至标题>¶</a></h3>
<p>过度使用模拟的一个问题是，它将您的测试与模拟的实现相结合，而不是与真正的代码相结合。假设您有一个实现 <code class="docutils literal notranslate"><span class=pre>some_method</span></code> . 在另一个类的测试中，您提供了这个对象的模拟 <em>also</em> 提供 <code class="docutils literal notranslate"><span class=pre>some_method</span></code> . 如果以后重构第一个类，使它不再具有 <code class="docutils literal notranslate"><span class=pre>some_method</span></code> -然后，即使您的代码现在被破坏，您的测试也将继续通过！</p>
<p><a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock title=unittest.mock.Mock><code class="xref py py-class docutils literal notranslate"><span class=pre>Mock</span></code></a> 允许您使用 <em>spec</em> 关键字参数。在模型上访问规范对象上不存在的方法/属性将立即引发属性错误。如果更改了规范的实现，那么使用该类的测试将立即失败，而不必在这些测试中实例化该类。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=n>SomeClass</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>old_method</span><span class=p>()</span>
<span class=gt>Traceback (most recent call last):</span>
   <span class=c>...</span>
<span class=gr>AttributeError</span><span>: </span><span class=n>object has no attribute 'old_method'</span>
</pre></div>
</div>
<p>使用规范还可以更智能地匹配对模拟进行的调用，无论某些参数是作为位置参数还是命名参数传递：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>c</span><span class=p>):</span> <span class=k>pass</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=n>f</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=go>&lt;Mock name='mock()' id='140161580456576'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>c</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</pre></div>
</div>
<p>如果您希望这种更智能的匹配也可以用于模拟上的方法调用，则可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#auto-speccing><span class="std std-ref">auto-speccing</span></a> .</p>
<p>如果您想要一种更强大的规范形式来阻止任意属性的设置和获取，那么您可以使用 <em>spec_set</em> 而不是 <em>spec</em> .</p>
</div>
</div>
<div class=section id=patch-decorators>
<h2>补丁装饰器<a class=headerlink href=#patch-decorators title=永久链接至标题>¶</a></h2>
<div class="admonition note">
<p class=admonition-title>注解</p>
<p>用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> 在查找对象的名称空间中修补对象很重要。这通常很简单，但为了快速阅读 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#where-to-patch><span class="std std-ref">where to patch</span></a> .</p>
</div>
<p>测试中的一个常见需求是修补一个类属性或模块属性，例如修补一个内置的或修补一个模块中的类来测试它是否被实例化。模块和类是有效的全局性的，因此在测试后必须撤消对它们的修补，否则修补程序将持续存在其他测试中，并导致难以诊断的问题。</p>
<p>Mock提供了三个方便的装饰： <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> ， <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch.object title=unittest.mock.patch.object><code class="xref py py-func docutils literal notranslate"><span class=pre>patch.object()</span></code></a> 和 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch.dict title=unittest.mock.patch.dict><code class="xref py py-func docutils literal notranslate"><span class=pre>patch.dict()</span></code></a> . <code class="docutils literal notranslate"><span class=pre>patch</span></code> 采用单字符串的形式 <code class="docutils literal notranslate"><span class=pre>package.module.Class.attribute</span></code> 指定要修补的属性。它还可以选择接受一个您希望用其替换属性（或类或其他）的值。patch.object'获取一个对象和要修补的属性的名称，以及要修补的值（可选）。</p>
<p><code class="docutils literal notranslate"><span class=pre>patch.object</span></code> ：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>original</span> <span class=o>=</span> <span class=n>SomeClass</span><span class=o>.</span><span class=n>attribute</span>
<span class=gp>&gt;&gt;&gt; </span><span class=nd>@patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>SomeClass</span><span class=p>,</span> <span class=s1>'attribute'</span><span class=p>,</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span><span class=p>)</span>
<span class=gp>... </span><span class=k>def</span> <span class=nf>test</span><span class=p>():</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>SomeClass</span><span class=o>.</span><span class=n>attribute</span> <span class=o>==</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>test</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=n>SomeClass</span><span class=o>.</span><span class=n>attribute</span> <span class=o>==</span> <span class=n>original</span>

<span class=gp>&gt;&gt;&gt; </span><span class=nd>@patch</span><span class=p>(</span><span class=s1>'package.module.attribute'</span><span class=p>,</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span><span class=p>)</span>
<span class=gp>... </span><span class=k>def</span> <span class=nf>test</span><span class=p>():</span>
<span class=gp>... </span>    <span class=kn>from</span> <span class=nn>package.module</span> <span class=kn>import</span> <span class=n>attribute</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>attribute</span> <span class=ow>is</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>test</span><span class=p>()</span>
</pre></div>
</div>
<p>如果您正在修补模块（包括 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/builtins.html#module-builtins title="builtins: The module that provides the built-in namespace."><code class="xref py py-mod docutils literal notranslate"><span class=pre>builtins</span></code></a> ）然后使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> 而不是 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch.object title=unittest.mock.patch.object><code class="xref py py-func docutils literal notranslate"><span class=pre>patch.object()</span></code></a> ：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=n>sentinel</span><span class=o>.</span><span class=n>file_handle</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'builtins.open'</span><span class=p>,</span> <span class=n>mock</span><span class=p>):</span>
<span class=gp>... </span>    <span class=n>handle</span> <span class=o>=</span> <span class=nb>open</span><span class=p>(</span><span class=s1>'filename'</span><span class=p>,</span> <span class=s1>'r'</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=s1>'filename'</span><span class=p>,</span> <span class=s1>'r'</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=n>handle</span> <span class=o>==</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>file_handle</span><span class=p>,</span> <span class=s2>"incorrect file handle returned"</span>
</pre></div>
</div>
<p>模块名称可以是“点式”的，格式为 <code class="docutils literal notranslate"><span class=pre>package.module</span></code> 如果需要：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=nd>@patch</span><span class=p>(</span><span class=s1>'package.module.ClassName.attribute'</span><span class=p>,</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span><span class=p>)</span>
<span class=gp>... </span><span class=k>def</span> <span class=nf>test</span><span class=p>():</span>
<span class=gp>... </span>    <span class=kn>from</span> <span class=nn>package.module</span> <span class=kn>import</span> <span class=n>ClassName</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>ClassName</span><span class=o>.</span><span class=n>attribute</span> <span class=o>==</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>test</span><span class=p>()</span>
</pre></div>
</div>
<p>一个好的模式是实际地装饰测试方法本身：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>... </span>    <span class=nd>@patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>SomeClass</span><span class=p>,</span> <span class=s1>'attribute'</span><span class=p>,</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_something</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>SomeClass</span><span class=o>.</span><span class=n>attribute</span><span class=p>,</span> <span class=n>sentinel</span><span class=o>.</span><span class=n>attribute</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>original</span> <span class=o>=</span> <span class=n>SomeClass</span><span class=o>.</span><span class=n>attribute</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_something'</span><span class=p>)</span><span class=o>.</span><span class=n>test_something</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=n>SomeClass</span><span class=o>.</span><span class=n>attribute</span> <span class=o>==</span> <span class=n>original</span>
</pre></div>
</div>
<p>如果你想用模型修补，你可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> 只有一个参数（或 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch.object title=unittest.mock.patch.object><code class="xref py py-func docutils literal notranslate"><span class=pre>patch.object()</span></code></a> 有两个参数）。模拟将为您创建并传递到测试函数/方法：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>... </span>    <span class=nd>@patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>SomeClass</span><span class=p>,</span> <span class=s1>'static_method'</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_something</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mock_method</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>SomeClass</span><span class=o>.</span><span class=n>static_method</span><span class=p>()</span>
<span class=gp>... </span>        <span class=n>mock_method</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>()</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_something'</span><span class=p>)</span><span class=o>.</span><span class=n>test_something</span><span class=p>()</span>
</pre></div>
</div>
<p>可以使用此模式堆叠多个修补程序装饰器：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>... </span>    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'package.module.ClassName1'</span><span class=p>)</span>
<span class=gp>... </span>    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'package.module.ClassName2'</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_something</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>MockClass2</span><span class=p>,</span> <span class=n>MockClass1</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>assertIs</span><span class=p>(</span><span class=n>package</span><span class=o>.</span><span class=n>module</span><span class=o>.</span><span class=n>ClassName1</span><span class=p>,</span> <span class=n>MockClass1</span><span class=p>)</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>assertIs</span><span class=p>(</span><span class=n>package</span><span class=o>.</span><span class=n>module</span><span class=o>.</span><span class=n>ClassName2</span><span class=p>,</span> <span class=n>MockClass2</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_something'</span><span class=p>)</span><span class=o>.</span><span class=n>test_something</span><span class=p>()</span>
</pre></div>
</div>
<p>当嵌套修补程序装饰器时，模拟将按它们应用的相同顺序传入装饰函数（正常 <em>Python</em> 命令应用装饰器）。这意味着从下到上，因此在上面的示例中， <code class="docutils literal notranslate"><span class=pre>test_module.ClassName2</span></code> 先通过。</p>
<p>也有 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch.dict title=unittest.mock.patch.dict><code class="xref py py-func docutils literal notranslate"><span class=pre>patch.dict()</span></code></a> 仅在作用域期间在字典中设置值，并在测试结束时将字典恢复到原始状态：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>foo</span> <span class=o>=</span> <span class=p>{</span><span class=s1>'key'</span><span class=p>:</span> <span class=s1>'value'</span><span class=p>}</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>original</span> <span class=o>=</span> <span class=n>foo</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>dict</span><span class=p>(</span><span class=n>foo</span><span class=p>,</span> <span class=p>{</span><span class=s1>'newkey'</span><span class=p>:</span> <span class=s1>'newvalue'</span><span class=p>},</span> <span class=n>clear</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>foo</span> <span class=o>==</span> <span class=p>{</span><span class=s1>'newkey'</span><span class=p>:</span> <span class=s1>'newvalue'</span><span class=p>}</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=n>foo</span> <span class=o>==</span> <span class=n>original</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class=pre>patch</span></code> ， <code class="docutils literal notranslate"><span class=pre>patch.object</span></code> 和 <code class="docutils literal notranslate"><span class=pre>patch.dict</span></code> 可以全部用作上下文管理器。</p>
<p>你在哪里使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> 要为您创建模拟，可以使用WITH语句的“as”形式获取对模拟的引用：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>ProductionClass</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>method</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>pass</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>ProductionClass</span><span class=p>,</span> <span class=s1>'method'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_method</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>mock_method</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=kc>None</span>
<span class=gp>... </span>    <span class=n>real</span> <span class=o>=</span> <span class=n>ProductionClass</span><span class=p>()</span>
<span class=gp>... </span>    <span class=n>real</span><span class=o>.</span><span class=n>method</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_method</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
</pre></div>
</div>
<p>作为替代方案 <code class="docutils literal notranslate"><span class=pre>patch</span></code> ， <code class="docutils literal notranslate"><span class=pre>patch.object</span></code> 和 <code class="docutils literal notranslate"><span class=pre>patch.dict</span></code> 可以用作类修饰器。当以这种方式使用时，它与将decorator单独应用于名称以“test”开头的每个方法相同。</p>
</div>
<div class=section id=further-examples>
<span id=id1></span><h2>其他示例<a class=headerlink href=#further-examples title=永久链接至标题>¶</a></h2>
<p>下面是一些更高级的场景的更多示例。</p>
<div class=section id=mocking-chained-calls>
<h3>模拟链接调用<a class=headerlink href=#mocking-chained-calls title=永久链接至标题>¶</a></h3>
<p>一旦您理解了 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.return_value title=unittest.mock.Mock.return_value><code class="xref py py-attr docutils literal notranslate"><span class=pre>return_value</span></code></a> 属性。当一个模拟被第一次调用时，或者你把它 <code class="docutils literal notranslate"><span class=pre>return_value</span></code> 在它被调用之前，一个新的 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock title=unittest.mock.Mock><code class="xref py py-class docutils literal notranslate"><span class=pre>Mock</span></code></a> 创建。</p>
<p>这意味着您可以看到从对模拟对象的调用返回的对象是如何通过询问 <code class="docutils literal notranslate"><span class=pre>return_value</span></code> 嘲弄：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span><span class=o>.</span><span class=n>foo</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
<span class=go>&lt;Mock name='mock().foo()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>foo</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</pre></div>
</div>
<p>从这里开始，配置然后断言链接调用是一个简单的步骤。当然，另一种选择是首先以更可测试的方式编写代码…</p>
<p>所以，假设我们有一些代码看起来有点像这样：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>Something</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>backend</span> <span class=o>=</span> <span class=n>BackendProvider</span><span class=p>()</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>method</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>response</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>backend</span><span class=o>.</span><span class=n>get_endpoint</span><span class=p>(</span><span class=s1>'foobar'</span><span class=p>)</span><span class=o>.</span><span class=n>create_call</span><span class=p>(</span><span class=s1>'spam'</span><span class=p>,</span> <span class=s1>'eggs'</span><span class=p>)</span><span class=o>.</span><span class=n>start_call</span><span class=p>()</span>
<span class=gp>... </span>        <span class=c1># more code</span>
</pre></div>
</div>
<p>假设 <code class="docutils literal notranslate"><span class=pre>BackendProvider</span></code> 已经做了很好的测试，我们如何测试 <code class="docutils literal notranslate"><span class=pre>method()</span></code> ？具体来说，我们要测试代码部分 <code class="docutils literal notranslate"><span class=pre>#</span> <span class=pre>more</span> <span class=pre>code</span></code> 以正确的方式使用响应对象。</p>
<p>由于此调用链是由实例属性发出的，因此我们可以对 <code class="docutils literal notranslate"><span class=pre>backend</span></code> 属性上的 <code class="docutils literal notranslate"><span class=pre>Something</span></code> 实例。在这种特殊情况下，我们只对 <code class="docutils literal notranslate"><span class=pre>start_call</span></code> 所以我们没有太多的配置要做。假设它返回的对象是“类似文件”的，因此我们将确保响应对象使用内置的 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/functions.html#open title=open><code class="xref py py-func docutils literal notranslate"><span class=pre>open()</span></code></a> 作为其 <code class="docutils literal notranslate"><span class=pre>spec</span></code> .</p>
<p>为此，我们创建一个模拟实例作为模拟后端，并为其创建一个模拟响应对象。将响应设置为最终结果的返回值 <code class="docutils literal notranslate"><span class=pre>start_call</span></code> 我们可以这样做：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><pre><span></span><span class=n>mock_backend</span><span class=o>.</span><span class=n>get_endpoint</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>create_call</span><span class=o>.</span><span class=n>return_value</span><span class=o>.</span><span class=n>start_call</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>mock_response</span>
</pre></div>
</div>
<p>我们可以用更好的方法 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.configure_mock title=unittest.mock.Mock.configure_mock><code class="xref py py-meth docutils literal notranslate"><span class=pre>configure_mock()</span></code></a> 直接为我们设置返回值的方法：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>something</span> <span class=o>=</span> <span class=n>Something</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_response</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>spec</span><span class=o>=</span><span class=nb>open</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_backend</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>config</span> <span class=o>=</span> <span class=p>{</span><span class=s1>'get_endpoint.return_value.create_call.return_value.start_call.return_value'</span><span class=p>:</span> <span class=n>mock_response</span><span class=p>}</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_backend</span><span class=o>.</span><span class=n>configure_mock</span><span class=p>(</span><span class=o>**</span><span class=n>config</span><span class=p>)</span>
</pre></div>
</div>
<p>有了这些，我们就可以在适当的地方修补“模拟后端”，并可以进行真正的调用：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>something</span><span class=o>.</span><span class=n>backend</span> <span class=o>=</span> <span class=n>mock_backend</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>something</span><span class=o>.</span><span class=n>method</span><span class=p>()</span>
</pre></div>
</div>
<p>使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.mock_calls title=unittest.mock.Mock.mock_calls><code class="xref py py-attr docutils literal notranslate"><span class=pre>mock_calls</span></code></a> 我们可以用一个断言检查链接调用。链接调用是一行代码中的多个调用，因此在 <code class="docutils literal notranslate"><span class=pre>mock_calls</span></code> . 我们可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.call.call_list title=unittest.mock.call.call_list><code class="xref py py-meth docutils literal notranslate"><span class=pre>call.call_list()</span></code></a> 要为我们创建此调用列表：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>chained</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=n>get_endpoint</span><span class=p>(</span><span class=s1>'foobar'</span><span class=p>)</span><span class=o>.</span><span class=n>create_call</span><span class=p>(</span><span class=s1>'spam'</span><span class=p>,</span> <span class=s1>'eggs'</span><span class=p>)</span><span class=o>.</span><span class=n>start_call</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>call_list</span> <span class=o>=</span> <span class=n>chained</span><span class=o>.</span><span class=n>call_list</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=n>mock_backend</span><span class=o>.</span><span class=n>mock_calls</span> <span class=o>==</span> <span class=n>call_list</span>
</pre></div>
</div>
</div>
<div class=section id=partial-mocking>
<h3>部分嘲讽<a class=headerlink href=#partial-mocking title=永久链接至标题>¶</a></h3>
<p>在一些测试中，我想模拟一个调用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/datetime.html#datetime.date.today title=datetime.date.today><code class="xref py py-meth docutils literal notranslate"><span class=pre>datetime.date.today()</span></code></a> 返回一个已知的日期，但我不想阻止正在测试的代码创建新的日期对象。不幸地 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/datetime.html#datetime.date title=datetime.date><code class="xref py py-class docutils literal notranslate"><span class=pre>datetime.date</span></code></a> 是用C语言写的，所以我不能仅仅用猴子来修补静态的 <code class="xref py py-meth docutils literal notranslate"><span class=pre>date.today()</span></code> 方法。</p>
<p>我发现了一种简单的方法，它包括用一个mock有效地封装日期类，但将调用传递给构造函数到实际类（并返回实际实例）。</p>
<p>这个 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch</span> <span class=pre>decorator</span></code></a> 在这里用来模拟 <code class="docutils literal notranslate"><span class=pre>date</span></code> 在测试模块中初始化。这个 <code class="xref py py-attr docutils literal notranslate"><span class=pre>side_effect</span></code> 然后将mock-date类的属性设置为返回实数的lambda函数。当模拟日期类被调用时，实际日期将由 <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> . ：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>datetime</span> <span class=kn>import</span> <span class=n>date</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.date'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_date</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>mock_date</span><span class=o>.</span><span class=n>today</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=n>date</span><span class=p>(</span><span class=mi>2010</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>mock_date</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=k>lambda</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>:</span> <span class=n>date</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kw</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span> <span class=o>==</span> <span class=n>date</span><span class=p>(</span><span class=mi>2010</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>date</span><span class=p>(</span><span class=mi>2009</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span> <span class=o>==</span> <span class=n>date</span><span class=p>(</span><span class=mi>2009</span><span class=p>,</span> <span class=mi>6</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</pre></div>
</div>
<p>注意，我们不修补 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/datetime.html#datetime.date title=datetime.date><code class="xref py py-class docutils literal notranslate"><span class=pre>datetime.date</span></code></a> 在全球范围内，我们修补 <code class="docutils literal notranslate"><span class=pre>date</span></code> 在模块中， <em>uses</em> 它。见 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#where-to-patch><span class="std std-ref">where to patch</span></a> .</p>
<p>什么时候？ <code class="docutils literal notranslate"><span class=pre>date.today()</span></code> 调用时返回已知日期，但调用 <code class="docutils literal notranslate"><span class=pre>date(...)</span></code> 构造函数仍返回正常日期。如果没有这个，你会发现自己必须使用与测试代码完全相同的算法来计算预期结果，这是一个经典的测试反模式。</p>
<p>对日期构造函数的调用记录在 <code class="docutils literal notranslate"><span class=pre>mock_date</span></code> 属性 (<code class="docutils literal notranslate"><span class=pre>call_count</span></code> 和朋友）这对你的测试也很有用。</p>
<p>中讨论了处理模拟日期或其他内置类的另一种方法。 <a class="reference external" href=https://williambert.online/2011/07/how-to-unit-testing-in-django-with-mocking-and-patching/>this blog entry</a> .</p>
</div>
<div class=section id=mocking-a-generator-method>
<h3>模拟生成器方法<a class=headerlink href=#mocking-a-generator-method title=永久链接至标题>¶</a></h3>
<p>python生成器是使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/reference/simple_stmts.html#yield><code class="xref std std-keyword docutils literal notranslate"><span class=pre>yield</span></code></a> 语句在迭代时返回一系列值 <a class="footnote-reference brackets" href=#id3 id=id2>1</a>.</p>
<p>调用生成器方法/函数以返回生成器对象。然后迭代生成程序对象。迭代的协议方法是 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/stdtypes.html#container.__iter__ title=container.__iter__><code class="xref py py-meth docutils literal notranslate"><span class=pre>__iter__()</span></code></a> ，以便我们可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.MagicMock title=unittest.mock.MagicMock><code class="xref py py-class docutils literal notranslate"><span class=pre>MagicMock</span></code></a> .</p>
<p>下面是一个示例类，其中的“iter”方法实现为生成器：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>Foo</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>iter</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>]:</span>
<span class=gp>... </span>            <span class=k>yield</span> <span class=n>i</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>foo</span> <span class=o>=</span> <span class=n>Foo</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=nb>list</span><span class=p>(</span><span class=n>foo</span><span class=o>.</span><span class=n>iter</span><span class=p>())</span>
<span class=go>[1, 2, 3]</span>
</pre></div>
</div>
<p>我们如何模拟这个类，特别是它的“iter”方法？</p>
<p>配置从迭代返回的值（隐式调用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/stdtypes.html#list title=list><code class="xref py py-class docutils literal notranslate"><span class=pre>list</span></code></a> ，我们需要配置调用返回的对象 <code class="docutils literal notranslate"><span class=pre>foo.iter()</span></code> .</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock_foo</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_foo</span><span class=o>.</span><span class=n>iter</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=nb>iter</span><span class=p>([</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>])</span>
<span class=gp>&gt;&gt;&gt; </span><span class=nb>list</span><span class=p>(</span><span class=n>mock_foo</span><span class=o>.</span><span class=n>iter</span><span class=p>())</span>
<span class=go>[1, 2, 3]</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class=label id=id3><span class=brackets><a class=fn-backref href=#id2>1</a></span></dt>
<dd><p>还有生成器表达式等等 <a class="reference external" href=http://www.dabeaz.com/coroutines/index.html>advanced uses</a> 但是我们不关心生成器。非常好地介绍了生成器及其功能： <a class="reference external" href=http://www.dabeaz.com/generators/>Generator Tricks for Systems Programmers</a> .</p>
</dd>
</dl>
</div>
<div class=section id=applying-the-same-patch-to-every-test-method>
<h3>对每个测试方法应用相同的补丁<a class=headerlink href=#applying-the-same-patch-to-every-test-method title=永久链接至标题>¶</a></h3>
<p>如果您想要为多个测试方法准备好几个补丁，最明显的方法是将补丁装饰器应用到每个方法。这感觉像是不必要的重复。对于python 2.6或更高版本，可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> （各种形式）作为一个类修饰器。这将补丁应用于类上的所有测试方法。测试方法由名称以开头的方法标识 <code class="docutils literal notranslate"><span class=pre>test</span></code> ：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=nd>@patch</span><span class=p>(</span><span class=s1>'mymodule.SomeClass'</span><span class=p>)</span>
<span class=gp>... </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_one</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>MockSomeClass</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>assertIs</span><span class=p>(</span><span class=n>mymodule</span><span class=o>.</span><span class=n>SomeClass</span><span class=p>,</span> <span class=n>MockSomeClass</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_two</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>MockSomeClass</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>assertIs</span><span class=p>(</span><span class=n>mymodule</span><span class=o>.</span><span class=n>SomeClass</span><span class=p>,</span> <span class=n>MockSomeClass</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>not_a_test</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=s1>'something'</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_one'</span><span class=p>)</span><span class=o>.</span><span class=n>test_one</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_two'</span><span class=p>)</span><span class=o>.</span><span class=n>test_two</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_two'</span><span class=p>)</span><span class=o>.</span><span class=n>not_a_test</span><span class=p>()</span>
<span class=go>'something'</span>
</pre></div>
</div>
<p>管理补丁的另一种方法是使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#start-and-stop><span class="std std-ref">修补方法：启动和停止</span></a> . 这些可以让你把补丁移到你的 <code class="docutils literal notranslate"><span class=pre>setUp</span></code> 和 <code class="docutils literal notranslate"><span class=pre>tearDown</span></code> 方法。：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.foo'</span><span class=p>)</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>mock_foo</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_foo</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>assertIs</span><span class=p>(</span><span class=n>mymodule</span><span class=o>.</span><span class=n>foo</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>mock_foo</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>tearDown</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>patcher</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_foo'</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</pre></div>
</div>
<p>如果使用此技术，则必须通过调用 <code class="docutils literal notranslate"><span class=pre>stop</span></code> . 这可能比您想象的更麻烦，因为如果在设置中引发异常，则不会调用TearDown。 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.html#unittest.TestCase.addCleanup title=unittest.TestCase.addCleanup><code class="xref py py-meth docutils literal notranslate"><span class=pre>unittest.TestCase.addCleanup()</span></code></a> 使这更容易：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.foo'</span><span class=p>)</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>addCleanup</span><span class=p>(</span><span class=n>patcher</span><span class=o>.</span><span class=n>stop</span><span class=p>)</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>mock_foo</span> <span class=o>=</span> <span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_foo</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>assertIs</span><span class=p>(</span><span class=n>mymodule</span><span class=o>.</span><span class=n>foo</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>mock_foo</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_foo'</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</pre></div>
</div>
</div>
<div class=section id=mocking-unbound-methods>
<h3>模拟未绑定方法<a class=headerlink href=#mocking-unbound-methods title=永久链接至标题>¶</a></h3>
<p>在今天编写测试时，我需要修补 <em>非绑定方法</em> （在类上而不是实例上修补方法）。我需要将self作为第一个参数传入，因为我想断言哪些对象正在调用这个特定的方法。问题是，您不能为此使用模拟修补，因为如果用模拟替换未绑定的方法，则从实例中提取时，它不会成为绑定方法，因此它不会自我传入。解决方法是用实函数来修补未绑定的方法。这个 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch title=unittest.mock.patch><code class="xref py py-func docutils literal notranslate"><span class=pre>patch()</span></code></a> decorator使得用一个mock修补方法变得非常简单，以至于必须创建一个真正的函数成为一个麻烦。</p>
<p>如果你通过 <code class="docutils literal notranslate"><span class=pre>autospec=True</span></code> 然后它用一个 <em>real</em> 函数对象。这个函数对象与它要替换的对象具有相同的签名，但是委托给了一个位于引擎盖下的模拟对象。您仍然可以使用与以前完全相同的方式创建模拟自动。但是，它的意思是，如果使用它来修补类上的未绑定方法，那么如果从实例中提取模拟函数，它将变成绑定方法。它将拥有 <code class="docutils literal notranslate"><span class=pre>self</span></code> 作为第一个参数传入，这正是我想要的：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>Foo</span><span class=p>:</span>
<span class=gp>... </span>  <span class=k>def</span> <span class=nf>foo</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>pass</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>object</span><span class=p>(</span><span class=n>Foo</span><span class=p>,</span> <span class=s1>'foo'</span><span class=p>,</span> <span class=n>autospec</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_foo</span><span class=p>:</span>
<span class=gp>... </span>  <span class=n>mock_foo</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=s1>'foo'</span>
<span class=gp>... </span>  <span class=n>foo</span> <span class=o>=</span> <span class=n>Foo</span><span class=p>()</span>
<span class=gp>... </span>  <span class=n>foo</span><span class=o>.</span><span class=n>foo</span><span class=p>()</span>
<span class=gp>...</span>
<span class=go>'foo'</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_foo</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=n>foo</span><span class=p>)</span>
</pre></div>
</div>
<p>如果我们不使用 <code class="docutils literal notranslate"><span class=pre>autospec=True</span></code> 然后用一个模拟实例修补未绑定的方法，而不是用 <code class="docutils literal notranslate"><span class=pre>self</span></code> .</p>
</div>
<div class=section id=checking-multiple-calls-with-mock>
<h3>使用模拟检查多个调用<a class=headerlink href=#checking-multiple-calls-with-mock title=永久链接至标题>¶</a></h3>
<p>mock有一个很好的API，用于断言如何使用模拟对象。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>foo_bar</span><span class=o>.</span><span class=n>return_value</span> <span class=o>=</span> <span class=kc>None</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>foo_bar</span><span class=p>(</span><span class=s1>'baz'</span><span class=p>,</span> <span class=n>spam</span><span class=o>=</span><span class=s1>'eggs'</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>foo_bar</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=s1>'baz'</span><span class=p>,</span> <span class=n>spam</span><span class=o>=</span><span class=s1>'eggs'</span><span class=p>)</span>
</pre></div>
</div>
<p>如果只有一次你可以使用 <code class="xref py py-meth docutils literal notranslate"><span class=pre>assert_called_once_with()</span></code> 方法，它还断言 <code class="xref py py-attr docutils literal notranslate"><span class=pre>call_count</span></code> 是一个。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>foo_bar</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s1>'baz'</span><span class=p>,</span> <span class=n>spam</span><span class=o>=</span><span class=s1>'eggs'</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>foo_bar</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>foo_bar</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>(</span><span class=s1>'baz'</span><span class=p>,</span> <span class=n>spam</span><span class=o>=</span><span class=s1>'eggs'</span><span class=p>)</span>
<span class=gt>Traceback (most recent call last):</span>
    <span class=o>...</span>
<span class=gr>AssertionError</span><span>: </span><span class=n>Expected to be called once. Called 2 times.</span>
</pre></div>
</div>
<p>两个 <code class="docutils literal notranslate"><span class=pre>assert_called_with</span></code> 和 <code class="docutils literal notranslate"><span class=pre>assert_called_once_with</span></code> 对 <em>最近的</em> 调用。如果你的模拟会被多次调用，而你想对 <em>all</em> 你可以用的调用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.call_args_list title=unittest.mock.Mock.call_args_list><code class="xref py py-attr docutils literal notranslate"><span class=pre>call_args_list</span></code></a> ：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>call_args_list</span>
<span class=go>[call(1, 2, 3), call(4, 5, 6), call()]</span>
</pre></div>
</div>
<p>这个 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.call title=unittest.mock.call><code class="xref py py-data docutils literal notranslate"><span class=pre>call</span></code></a> helper使断言这些调用变得容易。您可以建立一个预期调用的列表，并将其与 <code class="docutils literal notranslate"><span class=pre>call_args_list</span></code> . 这看起来与 <code class="docutils literal notranslate"><span class=pre>call_args_list</span></code> ：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>expected</span> <span class=o>=</span> <span class=p>[</span><span class=n>call</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>call</span><span class=p>(</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>),</span> <span class=n>call</span><span class=p>()]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>call_args_list</span> <span class=o>==</span> <span class=n>expected</span>
<span class=go>True</span>
</pre></div>
</div>
</div>
<div class=section id=coping-with-mutable-arguments>
<h3>处理可变参数<a class=headerlink href=#coping-with-mutable-arguments title=永久链接至标题>¶</a></h3>
<p>另一种情况是罕见的，但可以咬你，是当你的嘲笑被调用与可变的参数。 <code class="docutils literal notranslate"><span class=pre>call_args</span></code> 和 <code class="docutils literal notranslate"><span class=pre>call_args_list</span></code> 商店 <em>参考文献</em> 去参数。如果被测试的代码改变了参数，那么当调用mock时，就不能再断言值是什么。</p>
<p>下面是一些显示问题的示例代码。想象一下“mymodule”中定义的以下函数：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><pre><span></span><span class=k>def</span> <span class=nf>frob</span><span class=p>(</span><span class=n>val</span><span class=p>):</span>
    <span class=k>pass</span>

<span class=k>def</span> <span class=nf>grob</span><span class=p>(</span><span class=n>val</span><span class=p>):</span>
    <span class=s2>"First frob and then clear val"</span>
    <span class=n>frob</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
    <span class=n>val</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>
</pre></div>
</div>
<p>当我们试着测试的时候 <code class="docutils literal notranslate"><span class=pre>grob</span></code> 调用 <code class="docutils literal notranslate"><span class=pre>frob</span></code> 用正确的参数，看看会发生什么：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.frob'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_frob</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>val</span> <span class=o>=</span> <span class=p>{</span><span class=mi>6</span><span class=p>}</span>
<span class=gp>... </span>    <span class=n>mymodule</span><span class=o>.</span><span class=n>grob</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>val</span>
<span class=go>set()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_frob</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>({</span><span class=mi>6</span><span class=p>})</span>
<span class=gt>Traceback (most recent call last):</span>
    <span class=o>...</span>
<span class=gr>AssertionError</span><span>: </span><span class=n>Expected: (({6},), {})</span>
<span class=go>Called with: ((set(),), {})</span>
</pre></div>
</div>
<p>一种可能是模拟复制您传入的参数。如果您使用依赖对象标识来实现平等的断言，那么这可能会导致问题。</p>
<p>这里有一个解决方案使用 <code class="xref py py-attr docutils literal notranslate"><span class=pre>side_effect</span></code> 功能。如果你提供 <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 然后模拟函数 <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 将使用与mock相同的参数调用。这给了我们一个机会来复制这些参数，并将它们存储起来，以供以后的断言使用。在这个例子中，我使用 <em>另一个</em> mock存储参数，这样我就可以使用mock方法进行断言。另一个助手函数为我设置了这个。：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>copy</span> <span class=kn>import</span> <span class=n>deepcopy</span>
<span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>unittest.mock</span> <span class=kn>import</span> <span class=n>Mock</span><span class=p>,</span> <span class=n>patch</span><span class=p>,</span> <span class=n>DEFAULT</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>copy_call_args</span><span class=p>(</span><span class=n>mock</span><span class=p>):</span>
<span class=gp>... </span>    <span class=n>new_mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>side_effect</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>args</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>kwargs</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=n>kwargs</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>new_mock</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>DEFAULT</span>
<span class=gp>... </span>    <span class=n>mock</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=n>side_effect</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=n>new_mock</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.frob'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_frob</span><span class=p>:</span>
<span class=gp>... </span>    <span class=n>new_mock</span> <span class=o>=</span> <span class=n>copy_call_args</span><span class=p>(</span><span class=n>mock_frob</span><span class=p>)</span>
<span class=gp>... </span>    <span class=n>val</span> <span class=o>=</span> <span class=p>{</span><span class=mi>6</span><span class=p>}</span>
<span class=gp>... </span>    <span class=n>mymodule</span><span class=o>.</span><span class=n>grob</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>new_mock</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>({</span><span class=mi>6</span><span class=p>})</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>new_mock</span><span class=o>.</span><span class=n>call_args</span>
<span class=go>call({6})</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class=pre>copy_call_args</span></code> 用将要调用的模拟调用。它返回了一个新的模拟，我们对其进行断言。这个 <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 函数生成参数的副本并调用 <code class="docutils literal notranslate"><span class=pre>new_mock</span></code> 带着副本。</p>
<div class="admonition note">
<p class=admonition-title>注解</p>
<p>如果只有在调用参数时才使用模拟，那么有一种更简单的方法来检查参数。您只需在 <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 功能。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>side_effect</span><span class=p>(</span><span class=n>arg</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>assert</span> <span class=n>arg</span> <span class=o>==</span> <span class=p>{</span><span class=mi>6</span><span class=p>}</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=n>side_effect</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>({</span><span class=mi>6</span><span class=p>})</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>(</span><span class=nb>set</span><span class=p>())</span>
<span class=gt>Traceback (most recent call last):</span>
    <span class=o>...</span>
<span class=gr>AssertionError</span>
</pre></div>
</div>
</div>
<p>另一种方法是创建 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock title=unittest.mock.Mock><code class="xref py py-class docutils literal notranslate"><span class=pre>Mock</span></code></a> 或 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.MagicMock title=unittest.mock.MagicMock><code class="xref py py-class docutils literal notranslate"><span class=pre>MagicMock</span></code></a> 复制（使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/copy.html#copy.deepcopy title=copy.deepcopy><code class="xref py py-func docutils literal notranslate"><span class=pre>copy.deepcopy()</span></code></a> ）参数。下面是一个示例实现：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>from</span> <span class=nn>copy</span> <span class=kn>import</span> <span class=n>deepcopy</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>CopyingMock</span><span class=p>(</span><span class=n>MagicMock</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__call__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>/</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>args</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=n>args</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>kwargs</span> <span class=o>=</span> <span class=n>deepcopy</span><span class=p>(</span><span class=n>kwargs</span><span class=p>)</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=nb>super</span><span class=p>(</span><span class=n>CopyingMock</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__call__</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>c</span> <span class=o>=</span> <span class=n>CopyingMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>arg</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>c</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>arg</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>c</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=nb>set</span><span class=p>())</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>c</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span>
<span class=gt>Traceback (most recent call last):</span>
    <span class=o>...</span>
<span class=gr>AssertionError</span><span>: </span><span class=n>Expected call: mock({1})</span>
<span class=go>Actual call: mock(set())</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>c</span><span class=o>.</span><span class=n>foo</span>
<span class=go>&lt;CopyingMock name='mock.foo' id='...'&gt;</span>
</pre></div>
</div>
<p>当你子类 <code class="docutils literal notranslate"><span class=pre>Mock</span></code> 或 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 所有动态创建的属性，以及 <code class="docutils literal notranslate"><span class=pre>return_value</span></code> 将自动使用子类。这意味着所有的子项 <code class="docutils literal notranslate"><span class=pre>CopyingMock</span></code> 也将有类型 <code class="docutils literal notranslate"><span class=pre>CopyingMock</span></code> .</p>
</div>
<div class=section id=nesting-patches>
<h3>嵌套修补程序<a class=headerlink href=#nesting-patches title=永久链接至标题>¶</a></h3>
<p>将patch用作上下文管理器是很好的，但是如果您执行多个修补程序，则可以以嵌套的语句结尾，语句进一步向右缩进：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_foo</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.Foo'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_foo</span><span class=p>:</span>
<span class=gp>... </span>            <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.Bar'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_bar</span><span class=p>:</span>
<span class=gp>... </span>                <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.Spam'</span><span class=p>)</span> <span class=k>as</span> <span class=n>mock_spam</span><span class=p>:</span>
<span class=gp>... </span>                    <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Foo</span> <span class=ow>is</span> <span class=n>mock_foo</span>
<span class=gp>... </span>                    <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Bar</span> <span class=ow>is</span> <span class=n>mock_bar</span>
<span class=gp>... </span>                    <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Spam</span> <span class=ow>is</span> <span class=n>mock_spam</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>original</span> <span class=o>=</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Foo</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_foo'</span><span class=p>)</span><span class=o>.</span><span class=n>test_foo</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Foo</span> <span class=ow>is</span> <span class=n>original</span>
</pre></div>
</div>
<p>用UNITTEST <code class="docutils literal notranslate"><span class=pre>cleanup</span></code> 功能和 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#start-and-stop><span class="std std-ref">修补方法：启动和停止</span></a> 我们可以在没有嵌套缩进的情况下实现相同的效果。一个简单的助手方法， <code class="docutils literal notranslate"><span class=pre>create_patch</span></code> ，将补丁放置到位并返回为我们创建的模拟：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyTest</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>create_patch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>patcher</span> <span class=o>=</span> <span class=n>patch</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>thing</span> <span class=o>=</span> <span class=n>patcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>addCleanup</span><span class=p>(</span><span class=n>patcher</span><span class=o>.</span><span class=n>stop</span><span class=p>)</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>thing</span>
<span class=gp>...</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>test_foo</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=n>mock_foo</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_patch</span><span class=p>(</span><span class=s1>'mymodule.Foo'</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>mock_bar</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_patch</span><span class=p>(</span><span class=s1>'mymodule.Bar'</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>mock_spam</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_patch</span><span class=p>(</span><span class=s1>'mymodule.Spam'</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>... </span>        <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Foo</span> <span class=ow>is</span> <span class=n>mock_foo</span>
<span class=gp>... </span>        <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Bar</span> <span class=ow>is</span> <span class=n>mock_bar</span>
<span class=gp>... </span>        <span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Spam</span> <span class=ow>is</span> <span class=n>mock_spam</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>original</span> <span class=o>=</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Foo</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>MyTest</span><span class=p>(</span><span class=s1>'test_foo'</span><span class=p>)</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=n>mymodule</span><span class=o>.</span><span class=n>Foo</span> <span class=ow>is</span> <span class=n>original</span>
</pre></div>
</div>
</div>
<div class=section id=mocking-a-dictionary-with-magicmock>
<h3>用魔术师模仿字典<a class=headerlink href=#mocking-a-dictionary-with-magicmock title=永久链接至标题>¶</a></h3>
<p>您可能想要模拟一个字典或其他容器对象，记录对它的所有访问，同时让它仍然像一个字典一样工作。</p>
<p>我们可以用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.MagicMock title=unittest.mock.MagicMock><code class="xref py py-class docutils literal notranslate"><span class=pre>MagicMock</span></code></a> ，其行为将类似于字典，并使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.side_effect title=unittest.mock.Mock.side_effect><code class="xref py py-data docutils literal notranslate"><span class=pre>side_effect</span></code></a> 委托字典访问我们控制的真正的基础字典。</p>
<p>当 <a class="reference internal" href=https://www.osgeo.cn/cpython/reference/datamodel.html#object.__getitem__ title=object.__getitem__><code class="xref py py-meth docutils literal notranslate"><span class=pre>__getitem__()</span></code></a> 和 <a class="reference internal" href=https://www.osgeo.cn/cpython/reference/datamodel.html#object.__setitem__ title=object.__setitem__><code class="xref py py-meth docutils literal notranslate"><span class=pre>__setitem__()</span></code></a> 我们的方法 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 则称为（普通字典访问） <code class="docutils literal notranslate"><span class=pre>side_effect</span></code> 使用键调用 <code class="docutils literal notranslate"><span class=pre>__setitem__</span></code> 值也一样）。我们还可以控制返回的内容。</p>
<p>后 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 我们可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.call_args_list title=unittest.mock.Mock.call_args_list><code class="xref py py-data docutils literal notranslate"><span class=pre>call_args_list</span></code></a> 要断言词典的使用方式：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>my_dict</span> <span class=o>=</span> <span class=p>{</span><span class=s1>'a'</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>'b'</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>'c'</span><span class=p>:</span> <span class=mi>3</span><span class=p>}</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>getitem</span><span class=p>(</span><span class=n>name</span><span class=p>):</span>
<span class=gp>... </span>     <span class=k>return</span> <span class=n>my_dict</span><span class=p>[</span><span class=n>name</span><span class=p>]</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>setitem</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>val</span><span class=p>):</span>
<span class=gp>... </span>    <span class=n>my_dict</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__getitem__</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=n>getitem</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__setitem__</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=n>setitem</span>
</pre></div>
</div>
<div class="admonition note">
<p class=admonition-title>注解</p>
<p>替代使用 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 是使用 <code class="docutils literal notranslate"><span class=pre>Mock</span></code> 和 <em>only</em> 提供你特别想要的魔法方法：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__getitem__</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=n>getitem</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__setitem__</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>side_effect</span><span class=o>=</span><span class=n>setitem</span><span class=p>)</span>
</pre></div>
</div>
<p>A <em>第三的</em> 选项是使用 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 但通过 <code class="docutils literal notranslate"><span class=pre>dict</span></code> 作为 <em>spec</em> （或） <em>spec_set</em> ）参数使 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 只创建有字典魔术方法可用：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>(</span><span class=n>spec_set</span><span class=o>=</span><span class=nb>dict</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__getitem__</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=n>getitem</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__setitem__</span><span class=o>.</span><span class=n>side_effect</span> <span class=o>=</span> <span class=n>setitem</span>
</pre></div>
</div>
</div>
<p>当这些副作用功能到位时， <code class="docutils literal notranslate"><span class=pre>mock</span></code> 会像普通字典一样工作，但会记录访问。它甚至提高了 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/exceptions.html#KeyError title=KeyError><code class="xref py py-exc docutils literal notranslate"><span class=pre>KeyError</span></code></a> 如果试图访问不存在的密钥。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>[</span><span class=s1>'a'</span><span class=p>]</span>
<span class=go>1</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>[</span><span class=s1>'c'</span><span class=p>]</span>
<span class=go>3</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>[</span><span class=s1>'d'</span><span class=p>]</span>
<span class=gt>Traceback (most recent call last):</span>
    <span class=o>...</span>
<span class=gr>KeyError</span><span>: </span><span class=n>'d'</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>[</span><span class=s1>'b'</span><span class=p>]</span> <span class=o>=</span> <span class=s1>'fish'</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>[</span><span class=s1>'d'</span><span class=p>]</span> <span class=o>=</span> <span class=s1>'eggs'</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>[</span><span class=s1>'b'</span><span class=p>]</span>
<span class=go>'fish'</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>[</span><span class=s1>'d'</span><span class=p>]</span>
<span class=go>'eggs'</span>
</pre></div>
</div>
<p>使用后，可以使用普通模拟方法和属性对访问进行断言：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__getitem__</span><span class=o>.</span><span class=n>call_args_list</span>
<span class=go>[call('a'), call('c'), call('d'), call('b'), call('d')]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=fm>__setitem__</span><span class=o>.</span><span class=n>call_args_list</span>
<span class=go>[call('b', 'fish'), call('d', 'eggs')]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>my_dict</span>
<span class=go>{'a': 1, 'b': 'fish', 'c': 3, 'd': 'eggs'}</span>
</pre></div>
</div>
</div>
<div class=section id=mock-subclasses-and-their-attributes>
<h3>模拟子类及其属性<a class=headerlink href=#mock-subclasses-and-their-attributes title=永久链接至标题>¶</a></h3>
<p>您可能希望子类化的原因有很多 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock title=unittest.mock.Mock><code class="xref py py-class docutils literal notranslate"><span class=pre>Mock</span></code></a> . 一个原因可能是添加助手方法。下面是一个愚蠢的例子：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>MyMock</span><span class=p>(</span><span class=n>MagicMock</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>has_been_called</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>called</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span> <span class=o>=</span> <span class=n>MyMock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span>
<span class=go>&lt;MyMock id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=o>.</span><span class=n>has_been_called</span><span class=p>()</span>
<span class=go>False</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=o>.</span><span class=n>has_been_called</span><span class=p>()</span>
<span class=go>True</span>
</pre></div>
</div>
<p>标准行为 <code class="docutils literal notranslate"><span class=pre>Mock</span></code> 实例是，属性和返回值mock与访问它们的mock的类型相同。这确保了 <code class="docutils literal notranslate"><span class=pre>Mock</span></code> 属性是 <code class="docutils literal notranslate"><span class=pre>Mocks</span></code> 和 <code class="docutils literal notranslate"><span class=pre>MagicMock</span></code> 属性是 <code class="docutils literal notranslate"><span class=pre>MagicMocks</span></code> <a class="footnote-reference brackets" href=#id5 id=id4>2</a>. 因此，如果您要通过子类化来添加助手方法，那么它们也可以用于子类实例的属性和返回值模拟。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=o>.</span><span class=n>foo</span>
<span class=go>&lt;MyMock name='mock.foo' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=o>.</span><span class=n>foo</span><span class=o>.</span><span class=n>has_been_called</span><span class=p>()</span>
<span class=go>False</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=o>.</span><span class=n>foo</span><span class=p>()</span>
<span class=go>&lt;MyMock name='mock.foo()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=o>.</span><span class=n>foo</span><span class=o>.</span><span class=n>has_been_called</span><span class=p>()</span>
<span class=go>True</span>
</pre></div>
</div>
<p>有时这很不方便。例如， <a class="reference external" href=https://code.google.com/archive/p/mock/issues/105>one user</a> 子类化mock以创建 <a class="reference external" href=https://twistedmatrix.com/documents/11.0.0/api/twisted.python.components.html>Twisted adaptor</a> . 将此应用于属性也会导致错误。</p>
<p><code class="docutils literal notranslate"><span class=pre>Mock</span></code> （在它所有的味道中）使用一个方法 <code class="docutils literal notranslate"><span class=pre>_get_child_mock</span></code> 为属性和返回值创建这些“子模拟”。通过重写此方法，可以防止子类用于属性。签名是采用任意关键字参数 (<code class="docutils literal notranslate"><span class=pre>**kwargs</span></code> ）然后传递给模拟构造函数：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>Subclass</span><span class=p>(</span><span class=n>MagicMock</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=nf>_get_child_mock</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>/</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=n>MagicMock</span><span class=p>(</span><span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span> <span class=o>=</span> <span class=n>Subclass</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mymock</span><span class=o>.</span><span class=n>foo</span>
<span class=go>&lt;MagicMock name='mock.foo' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mymock</span><span class=p>,</span> <span class=n>Subclass</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mymock</span><span class=o>.</span><span class=n>foo</span><span class=p>,</span> <span class=n>Subclass</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>mymock</span><span class=p>(),</span> <span class=n>Subclass</span><span class=p>)</span>
</pre></div>
</div>
<dl class="footnote brackets">
<dt class=label id=id5><span class=brackets><a class=fn-backref href=#id4>2</a></span></dt>
<dd><p>此规则的一个例外是不可调用的模拟。属性使用可调用变量，因为否则不可调用mock不能有可调用方法。</p>
</dd>
</dl>
</div>
<div class=section id=mocking-imports-with-patch-dict>
<h3>使用patch.dict模拟导入<a class=headerlink href=#mocking-imports-with-patch-dict title=永久链接至标题>¶</a></h3>
<p>模拟可能很困难的一种情况是在函数内部有一个本地导入。因为它们不使用我们可以修补的模块名称空间中的对象，所以很难模仿它们。</p>
<p>一般来说，应避免本地输入。它们有时是为了防止循环依赖性，因为 <em>通常</em> 通过延迟导入来解决问题（重构代码）或防止“前期成本”的更好方法。这也可以用比无条件本地导入更好的方法来解决（将模块存储为类或模块属性，并且只在第一次使用时进行导入）。</p>
<p>除此之外，还有一种使用方法 <code class="docutils literal notranslate"><span class=pre>mock</span></code> 影响导入的结果。导入获取 <em>object</em> 从 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/sys.html#sys.modules title=sys.modules><code class="xref py py-data docutils literal notranslate"><span class=pre>sys.modules</span></code></a> 字典。注意，它获取一个 <em>object</em> ，不必是模块。首次导入模块会导致将模块对象放入 <cite>sys.modules</cite> ，所以通常当导入某些内容时，会返回模块。但情况并非如此。</p>
<p>这意味着你可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.patch.dict title=unittest.mock.patch.dict><code class="xref py py-func docutils literal notranslate"><span class=pre>patch.dict()</span></code></a> 到 <em>暂时地</em> 把一个模型放进去 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/sys.html#sys.modules title=sys.modules><code class="xref py py-data docutils literal notranslate"><span class=pre>sys.modules</span></code></a> . 当这个补丁处于活动状态时，任何导入都将获取模拟。补丁完成后（修饰函数退出，WITH语句体完成或 <code class="docutils literal notranslate"><span class=pre>patcher.stop()</span></code> 则以前存在的内容将安全还原。</p>
<p>下面是一个模拟“fooble”模块的例子。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span> <span class=nn>sys</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>dict</span><span class=p>(</span><span class=s1>'sys.modules'</span><span class=p>,</span> <span class=p>{</span><span class=s1>'fooble'</span><span class=p>:</span> <span class=n>mock</span><span class=p>}):</span>
<span class=gp>... </span>   <span class=kn>import</span> <span class=nn>fooble</span>
<span class=gp>... </span>   <span class=n>fooble</span><span class=o>.</span><span class=n>blob</span><span class=p>()</span>
<span class=gp>...</span>
<span class=go>&lt;Mock name='mock.blob()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>assert</span> <span class=s1>'fooble'</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>sys</span><span class=o>.</span><span class=n>modules</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>blob</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>()</span>
</pre></div>
</div>
<p>你可以看到 <code class="docutils literal notranslate"><span class=pre>import</span> <span class=pre>fooble</span></code> 成功了，但在出口处没有留下“fooble” <a class="reference internal" href=https://www.osgeo.cn/cpython/library/sys.html#sys.modules title=sys.modules><code class="xref py py-data docutils literal notranslate"><span class=pre>sys.modules</span></code></a> .</p>
<p>这也适用于 <code class="docutils literal notranslate"><span class=pre>from</span> <span class=pre>module</span> <span class=pre>import</span> <span class=pre>name</span></code> 形式：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>dict</span><span class=p>(</span><span class=s1>'sys.modules'</span><span class=p>,</span> <span class=p>{</span><span class=s1>'fooble'</span><span class=p>:</span> <span class=n>mock</span><span class=p>}):</span>
<span class=gp>... </span>   <span class=kn>from</span> <span class=nn>fooble</span> <span class=kn>import</span> <span class=n>blob</span>
<span class=gp>... </span>   <span class=n>blob</span><span class=o>.</span><span class=n>blip</span><span class=p>()</span>
<span class=gp>...</span>
<span class=go>&lt;Mock name='mock.blob.blip()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>blob</span><span class=o>.</span><span class=n>blip</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>()</span>
</pre></div>
</div>
<p>通过稍微多做一些工作，您还可以模拟包导入：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>modules</span> <span class=o>=</span> <span class=p>{</span><span class=s1>'package'</span><span class=p>:</span> <span class=n>mock</span><span class=p>,</span> <span class=s1>'package.module'</span><span class=p>:</span> <span class=n>mock</span><span class=o>.</span><span class=n>module</span><span class=p>}</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=o>.</span><span class=n>dict</span><span class=p>(</span><span class=s1>'sys.modules'</span><span class=p>,</span> <span class=n>modules</span><span class=p>):</span>
<span class=gp>... </span>   <span class=kn>from</span> <span class=nn>package.module</span> <span class=kn>import</span> <span class=n>fooble</span>
<span class=gp>... </span>   <span class=n>fooble</span><span class=p>()</span>
<span class=gp>...</span>
<span class=go>&lt;Mock name='mock.module.fooble()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>module</span><span class=o>.</span><span class=n>fooble</span><span class=o>.</span><span class=n>assert_called_once_with</span><span class=p>()</span>
</pre></div>
</div>
</div>
<div class=section id=tracking-order-of-calls-and-less-verbose-call-assertions>
<h3>跟踪调用顺序，减少冗长的调用断言<a class=headerlink href=#tracking-order-of-calls-and-less-verbose-call-assertions title=永久链接至标题>¶</a></h3>
<p>这个 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock title=unittest.mock.Mock><code class="xref py py-class docutils literal notranslate"><span class=pre>Mock</span></code></a> 类允许您跟踪 <em>秩序</em> 通过 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.method_calls title=unittest.mock.Mock.method_calls><code class="xref py py-attr docutils literal notranslate"><span class=pre>method_calls</span></code></a> 属性。这不允许您跟踪不同模拟对象之间的调用顺序，但是我们可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.mock_calls title=unittest.mock.Mock.mock_calls><code class="xref py py-attr docutils literal notranslate"><span class=pre>mock_calls</span></code></a> 达到同样的效果。</p>
<p>因为mocks跟踪对子项的调用mocks in <code class="docutils literal notranslate"><span class=pre>mock_calls</span></code> 访问一个mock的任意属性会创建一个子mock，我们可以从父mock创建单独的mock。然后，所有对这些模仿子项的调用将按顺序记录在 <code class="docutils literal notranslate"><span class=pre>mock_calls</span></code> 父母的：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>manager</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_foo</span> <span class=o>=</span> <span class=n>manager</span><span class=o>.</span><span class=n>foo</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_bar</span> <span class=o>=</span> <span class=n>manager</span><span class=o>.</span><span class=n>bar</span>
</pre></div>
</div>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>mock_foo</span><span class=o>.</span><span class=n>something</span><span class=p>()</span>
<span class=go>&lt;Mock name='mock.foo.something()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock_bar</span><span class=o>.</span><span class=n>other</span><span class=o>.</span><span class=n>thing</span><span class=p>()</span>
<span class=go>&lt;Mock name='mock.bar.other.thing()' id='...'&gt;</span>
</pre></div>
</div>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>manager</span><span class=o>.</span><span class=n>mock_calls</span>
<span class=go>[call.foo.something(), call.bar.other.thing()]</span>
</pre></div>
</div>
<p>然后，通过与 <code class="docutils literal notranslate"><span class=pre>mock_calls</span></code> 经理模拟的属性：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>expected_calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>call</span><span class=o>.</span><span class=n>foo</span><span class=o>.</span><span class=n>something</span><span class=p>(),</span> <span class=n>call</span><span class=o>.</span><span class=n>bar</span><span class=o>.</span><span class=n>other</span><span class=o>.</span><span class=n>thing</span><span class=p>()]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>manager</span><span class=o>.</span><span class=n>mock_calls</span> <span class=o>==</span> <span class=n>expected_calls</span>
<span class=go>True</span>
</pre></div>
</div>
<p>如果 <code class="docutils literal notranslate"><span class=pre>patch</span></code> 正在创建并放置模拟，然后可以使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.attach_mock title=unittest.mock.Mock.attach_mock><code class="xref py py-meth docutils literal notranslate"><span class=pre>attach_mock()</span></code></a> 方法。附加调用后将记录在 <code class="docutils literal notranslate"><span class=pre>mock_calls</span></code> 经理的。：：</p>
<div class="highlight-python3 notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>manager</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.Class1'</span><span class=p>)</span> <span class=k>as</span> <span class=n>MockClass1</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'mymodule.Class2'</span><span class=p>)</span> <span class=k>as</span> <span class=n>MockClass2</span><span class=p>:</span>
<span class=gp>... </span>        <span class=n>manager</span><span class=o>.</span><span class=n>attach_mock</span><span class=p>(</span><span class=n>MockClass1</span><span class=p>,</span> <span class=s1>'MockClass1'</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>manager</span><span class=o>.</span><span class=n>attach_mock</span><span class=p>(</span><span class=n>MockClass2</span><span class=p>,</span> <span class=s1>'MockClass2'</span><span class=p>)</span>
<span class=gp>... </span>        <span class=n>MockClass1</span><span class=p>()</span><span class=o>.</span><span class=n>foo</span><span class=p>()</span>
<span class=gp>... </span>        <span class=n>MockClass2</span><span class=p>()</span><span class=o>.</span><span class=n>bar</span><span class=p>()</span>
<span class=go>&lt;MagicMock name='mock.MockClass1().foo()' id='...'&gt;</span>
<span class=go>&lt;MagicMock name='mock.MockClass2().bar()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>manager</span><span class=o>.</span><span class=n>mock_calls</span>
<span class=go>[call.MockClass1(),</span>
<span class=go>call.MockClass1().foo(),</span>
<span class=go>call.MockClass2(),</span>
<span class=go>call.MockClass2().bar()]</span>
</pre></div>
</div>
<p>如果已经打了许多调用，但您只对其中的特定序列感兴趣，那么另一种选择是使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.assert_has_calls title=unittest.mock.Mock.assert_has_calls><code class="xref py py-meth docutils literal notranslate"><span class=pre>assert_has_calls()</span></code></a> 方法。它接受一个调用列表（用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.call title=unittest.mock.call><code class="xref py py-data docutils literal notranslate"><span class=pre>call</span></code></a> 对象）。如果那一系列的调用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.mock_calls title=unittest.mock.Mock.mock_calls><code class="xref py py-attr docutils literal notranslate"><span class=pre>mock_calls</span></code></a> 然后断言成功。</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>m</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>m</span><span class=p>()</span><span class=o>.</span><span class=n>foo</span><span class=p>()</span><span class=o>.</span><span class=n>bar</span><span class=p>()</span><span class=o>.</span><span class=n>baz</span><span class=p>()</span>
<span class=go>&lt;MagicMock name='mock().foo().bar().baz()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>m</span><span class=o>.</span><span class=n>one</span><span class=p>()</span><span class=o>.</span><span class=n>two</span><span class=p>()</span><span class=o>.</span><span class=n>three</span><span class=p>()</span>
<span class=go>&lt;MagicMock name='mock.one().two().three()' id='...'&gt;</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>calls</span> <span class=o>=</span> <span class=n>call</span><span class=o>.</span><span class=n>one</span><span class=p>()</span><span class=o>.</span><span class=n>two</span><span class=p>()</span><span class=o>.</span><span class=n>three</span><span class=p>()</span><span class=o>.</span><span class=n>call_list</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>m</span><span class=o>.</span><span class=n>assert_has_calls</span><span class=p>(</span><span class=n>calls</span><span class=p>)</span>
</pre></div>
</div>
<p>即使是被锁起来的调用 <code class="docutils literal notranslate"><span class=pre>m.one().two().three()</span></code> 并不是唯一对模拟进行调用，断言仍然成功。</p>
<p>有时，一个模拟可能有几个调用，你只对断言感兴趣 <em>some</em> 这些调用。你甚至可能不关心订单。在这种情况下，你可以通过 <code class="docutils literal notranslate"><span class=pre>any_order=True</span></code> 到 <code class="docutils literal notranslate"><span class=pre>assert_has_calls</span></code> ：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>m</span> <span class=o>=</span> <span class=n>MagicMock</span><span class=p>()</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>m</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>m</span><span class=o>.</span><span class=n>two</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>),</span> <span class=n>m</span><span class=o>.</span><span class=n>seven</span><span class=p>(</span><span class=mi>7</span><span class=p>),</span> <span class=n>m</span><span class=o>.</span><span class=n>fifty</span><span class=p>(</span><span class=s1>'50'</span><span class=p>)</span>
<span class=go>(...)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>calls</span> <span class=o>=</span> <span class=p>[</span><span class=n>call</span><span class=o>.</span><span class=n>fifty</span><span class=p>(</span><span class=s1>'50'</span><span class=p>),</span> <span class=n>call</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span> <span class=n>call</span><span class=o>.</span><span class=n>seven</span><span class=p>(</span><span class=mi>7</span><span class=p>)]</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>m</span><span class=o>.</span><span class=n>assert_has_calls</span><span class=p>(</span><span class=n>calls</span><span class=p>,</span> <span class=n>any_order</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</pre></div>
</div>
</div>
<div class=section id=more-complex-argument-matching>
<h3>更复杂的参数匹配<a class=headerlink href=#more-complex-argument-matching title=永久链接至标题>¶</a></h3>
<p>使用与 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.ANY title=unittest.mock.ANY><code class="xref py py-data docutils literal notranslate"><span class=pre>ANY</span></code></a> 我们可以实现matcher来对用作模拟参数的对象进行更复杂的断言。</p>
<p>假设我们期望将某个对象传递给一个mock，该mock默认情况下根据对象标识比较相等（这是用户定义类的python默认值）。使用 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/unittest.mock.html#unittest.mock.Mock.assert_called_with title=unittest.mock.Mock.assert_called_with><code class="xref py py-meth docutils literal notranslate"><span class=pre>assert_called_with()</span></code></a> 我们需要传递完全相同的对象。如果我们只对这个对象的一些属性感兴趣，那么我们可以创建一个匹配器来检查这些属性。</p>
<p>在这个例子中，您可以看到“标准”调用 <code class="docutils literal notranslate"><span class=pre>assert_called_with</span></code> 不够：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>Foo</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>a</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>b</span> <span class=o>=</span> <span class=n>a</span><span class=p>,</span> <span class=n>b</span>
<span class=gp>...</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span> <span class=o>=</span> <span class=n>Mock</span><span class=p>(</span><span class=n>return_value</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=p>(</span><span class=n>Foo</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=n>Foo</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
<span class=gt>Traceback (most recent call last):</span>
    <span class=o>...</span>
<span class=gr>AssertionError</span><span>: </span><span class=n>Expected: call(&lt;__main__.Foo object at 0x...&gt;)</span>
<span class=go>Actual call: call(&lt;__main__.Foo object at 0x...&gt;)</span>
</pre></div>
</div>
<p>我们的比较函数 <code class="docutils literal notranslate"><span class=pre>Foo</span></code> 类可能如下所示：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>def</span> <span class=nf>compare</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>other</span><span class=p>):</span>
<span class=gp>... </span>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>type</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>==</span> <span class=nb>type</span><span class=p>(</span><span class=n>other</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span>
<span class=gp>... </span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>a</span> <span class=o>!=</span> <span class=n>other</span><span class=o>.</span><span class=n>a</span><span class=p>:</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span>
<span class=gp>... </span>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>b</span> <span class=o>!=</span> <span class=n>other</span><span class=o>.</span><span class=n>b</span><span class=p>:</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=kc>False</span>
<span class=gp>... </span>    <span class=k>return</span> <span class=kc>True</span>
<span class=gp>...</span>
</pre></div>
</div>
<p>如果matcher对象可以使用类似这样的比较函数进行相等操作，那么它的外观应该是这样的：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=k>class</span> <span class=nc>Matcher</span><span class=p>:</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>compare</span><span class=p>,</span> <span class=n>some_obj</span><span class=p>):</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>compare</span> <span class=o>=</span> <span class=n>compare</span>
<span class=gp>... </span>        <span class=bp>self</span><span class=o>.</span><span class=n>some_obj</span> <span class=o>=</span> <span class=n>some_obj</span>
<span class=gp>... </span>    <span class=k>def</span> <span class=fm>__eq__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>other</span><span class=p>):</span>
<span class=gp>... </span>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>compare</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>some_obj</span><span class=p>,</span> <span class=n>other</span><span class=p>)</span>
<span class=gp>...</span>
</pre></div>
</div>
<p>把这些放在一起：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>match_foo</span> <span class=o>=</span> <span class=n>Matcher</span><span class=p>(</span><span class=n>compare</span><span class=p>,</span> <span class=n>Foo</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>))</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=n>match_foo</span><span class=p>)</span>
</pre></div>
</div>
<p>这个 <code class="docutils literal notranslate"><span class=pre>Matcher</span></code> 用我们的比较函数和 <code class="docutils literal notranslate"><span class=pre>Foo</span></code> 我们要比较的对象。在 <code class="docutils literal notranslate"><span class=pre>assert_called_with</span></code> 这个 <code class="docutils literal notranslate"><span class=pre>Matcher</span></code> 将调用相等方法，该方法将mock调用的对象与创建matcher时使用的对象进行比较。如果他们匹配的话 <code class="docutils literal notranslate"><span class=pre>assert_called_with</span></code> 通过，如果他们不是 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/exceptions.html#AssertionError title=AssertionError><code class="xref py py-exc docutils literal notranslate"><span class=pre>AssertionError</span></code></a> 提出：</p>
<div class="highlight-default notranslate" style=position:relative><div class=highlight><span class=copybutton title="Hide the prompts and output" style="cursor:pointer;position:absolute;top:0px;right:0px;border-color:#aacc99;border-style:solid;border-width:1px;color:#aacc99;font-family:monospace;padding-left:.2em;padding-right:.2em;border-radius:0px 3px 0px 0px">&gt;&gt;&gt;</span><pre><span></span><span class=gp>&gt;&gt;&gt; </span><span class=n>match_wrong</span> <span class=o>=</span> <span class=n>Matcher</span><span class=p>(</span><span class=n>compare</span><span class=p>,</span> <span class=n>Foo</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>))</span>
<span class=gp>&gt;&gt;&gt; </span><span class=n>mock</span><span class=o>.</span><span class=n>assert_called_with</span><span class=p>(</span><span class=n>match_wrong</span><span class=p>)</span>
<span class=gt>Traceback (most recent call last):</span>
    <span class=o>...</span>
<span class=gr>AssertionError</span><span>: </span><span class=n>Expected: ((&lt;Matcher object at 0x...&gt;,), {})</span>
<span class=go>Called with: ((&lt;Foo object at 0x...&gt;,), {})</span>
</pre></div>
</div>
<p>稍微调整一下，你就可以让比较函数提高 <a class="reference internal" href=https://www.osgeo.cn/cpython/library/exceptions.html#AssertionError title=AssertionError><code class="xref py py-exc docutils literal notranslate"><span class=pre>AssertionError</span></code></a> 直接并提供更有用的故障消息。</p>
<p>从1.5版开始，python测试库 <a class="reference external" href=https://pyhamcrest.readthedocs.io/>PyHamcrest</a> 以相等匹配器的形式提供类似的功能，在这里可能有用（<a class="reference external" href=https://pyhamcrest.readthedocs.io/en/release-1.8/integration/#module-hamcrest.library.integration.match_equality>hamcrest.library.integration.match_equality</a>) .</p>
</div>
</div>
</div>
 </div>
 </div>
 </div>
 
 
 </div> 
 
 
 
<div id=saladict-saladbowl-root class="saladict-div saladict-external" style=display:none!important><div class=saladict-external style=display:none!important><template shadowmode=open style=display:none!important><div style=animation:initial;transition:initial;color:initial;font:initial;font-feature-settings:initial;font-kerning:initial;font-optical-sizing:initial;font-variation-settings:initial;text-orientation:initial;text-rendering:initial;-webkit-font-smoothing:initial;-webkit-locale:initial;-webkit-text-orientation:initial;-webkit-writing-mode:initial;writing-mode:initial;zoom:initial;place-content:initial;place-items:initial;place-self:initial;alignment-baseline:initial;backdrop-filter:initial;backface-visibility:initial;background:initial;background-blend-mode:initial;baseline-shift:initial;block-size:initial;border-block-end:initial;border-block-start:initial;border:initial;border-radius:initial;border-collapse:initial;border-inline-end:initial;border-inline-start:initial;bottom:initial;box-shadow:initial;box-sizing:initial;break-after:initial;break-before:initial;break-inside:initial;buffered-rendering:initial;caption-side:initial;caret-color:initial;clear:initial;clip:initial;clip-path:initial;clip-rule:initial;color-interpolation:initial;color-interpolation-filters:initial;color-rendering:initial;columns:initial;column-fill:initial;gap:initial;column-rule:initial;column-span:initial;contain:initial;content:initial;counter-increment:initial;counter-reset:initial;cursor:initial;cx:initial;cy:initial;d:initial;display:none!important;dominant-baseline:initial;empty-cells:initial;fill:initial;fill-opacity:initial;fill-rule:initial;filter:initial;flex:initial;flex-flow:initial;float:initial;flood-color:initial;flood-opacity:initial;grid:initial;grid-area:initial;height:initial;hyphens:initial;image-rendering:initial;inline-size:initial;isolation:initial;left:initial;letter-spacing:initial;lighting-color:initial;line-break:initial;list-style:initial;margin-block-end:initial;margin-block-start:initial;margin:initial;margin-inline-end:initial;margin-inline-start:initial;marker:initial;mask:initial;mask-type:initial;max-block-size:initial;max-height:initial;max-inline-size:initial;max-width:initial;min-block-size:initial;min-height:initial;min-inline-size:initial;min-width:initial;mix-blend-mode:initial;object-fit:initial;object-position:initial;offset:initial;opacity:initial;order:initial;orphans:initial;outline:initial;outline-offset:initial;overflow-anchor:initial;overflow-wrap:initial;overflow:initial;overscroll-behavior-block:initial;overscroll-behavior-inline:initial;overscroll-behavior:initial;padding-block-end:initial;padding-block-start:initial;padding:initial;padding-inline-end:initial;padding-inline-start:initial;page:initial;paint-order:initial;perspective:initial;perspective-origin:initial;pointer-events:initial;position:initial;quotes:initial;r:initial;resize:initial;right:initial;rx:initial;ry:initial;scroll-behavior:initial;scroll-margin-block:initial;scroll-margin:initial;scroll-margin-inline:initial;scroll-padding-block:initial;scroll-padding:initial;scroll-padding-inline:initial;scroll-snap-align:initial;scroll-snap-stop:initial;scroll-snap-type:initial;shape-image-threshold:initial;shape-margin:initial;shape-outside:initial;shape-rendering:initial;size:initial;speak:initial;stop-color:initial;stop-opacity:initial;stroke:initial;stroke-dasharray:initial;stroke-dashoffset:initial;stroke-linecap:initial;stroke-linejoin:initial;stroke-miterlimit:initial;stroke-opacity:initial;stroke-width:initial;tab-size:initial;table-layout:initial;text-align:initial;text-align-last:initial;text-anchor:initial;text-combine-upright:initial;text-decoration:initial;text-decoration-skip-ink:initial;text-indent:initial;text-overflow:initial;text-shadow:initial;text-size-adjust:initial;text-transform:initial;text-underline-position:initial;top:initial;touch-action:initial;transform:initial;transform-box:initial;transform-origin:initial;transform-style:initial;user-select:initial;vector-effect:initial;vertical-align:initial;visibility:initial;-webkit-app-region:initial;-webkit-appearance:initial;border-spacing:initial;-webkit-border-image:initial;-webkit-box-align:initial;-webkit-box-decoration-break:initial;-webkit-box-direction:initial;-webkit-box-flex:initial;-webkit-box-ordinal-group:initial;-webkit-box-orient:initial;-webkit-box-pack:initial;-webkit-box-reflect:initial;-webkit-font-size-delta:initial;-webkit-highlight:initial;-webkit-hyphenate-character:initial;-webkit-line-break:initial;-webkit-line-clamp:initial;-webkit-margin-collapse:initial;-webkit-margin-bottom-collapse:initial;-webkit-margin-top-collapse:initial;-webkit-mask-box-image:initial;-webkit-mask:initial;-webkit-mask-composite:initial;-webkit-perspective-origin-x:initial;-webkit-perspective-origin-y:initial;-webkit-print-color-adjust:initial;-webkit-rtl-ordering:initial;-webkit-ruby-position:initial;-webkit-tap-highlight-color:initial;-webkit-text-combine:initial;-webkit-text-decorations-in-effect:initial;-webkit-text-emphasis:initial;-webkit-text-emphasis-position:initial;-webkit-text-fill-color:initial;-webkit-text-security:initial;-webkit-text-stroke:initial;-webkit-transform-origin-x:initial;-webkit-transform-origin-y:initial;-webkit-transform-origin-z:initial;-webkit-user-drag:initial;-webkit-user-modify:initial;white-space:initial;widows:initial;width:initial;will-change:initial;word-break:initial;word-spacing:initial;x:initial;y:initial;z-index:initial><style>.saladbowl{position:fixed;z-index:2147483647;top:0;left:0;width:30px;height:30px;-moz-user-select:none;user-select:none;cursor:pointer}.isAnimate.saladbowl{will-change:transform;transition:transform .3s ease-out}.isAnimate.saladbowl.enableHover:hover .saladbowl-leaf{animation:saladbowl-leaf-shake .7s infinite linear}.isAnimate.saladbowl.enableHover:hover .saladbowl-orange{transform-origin:301.8px 187.4px;animation:saladbowl-orange-spin .7s infinite linear}.isAnimate.saladbowl.enableHover:hover .saladbowl-tomato{transform-origin:297.8px 126.4px;animation:saladbowl-tomato-shake .7s infinite linear}.isAnimate.saladbowl-enter-active>svg{animation:saladbowl-jelly 1s linear}.isAnimate.saladbowl-exit{opacity:1}.isAnimate.saladbowl-exit-active{opacity:0;transition:opacity .1s}.saladbowl-exit-done{display:none}@keyframes saladbowl-jelly{0%{transform:matrix3d(.5,0,0,0,0,.5,0,0,0,0,1,0,0,0,0,1)}3.40%{transform:matrix3d(.658,0,0,0,0,.703,0,0,0,0,1,0,0,0,0,1)}4.70%{transform:matrix3d(.725,0,0,0,0,.8,0,0,0,0,1,0,0,0,0,1)}6.81%{transform:matrix3d(.83,0,0,0,0,.946,0,0,0,0,1,0,0,0,0,1)}9.41%{transform:matrix3d(.942,0,0,0,0,1.084,0,0,0,0,1,0,0,0,0,1)}10.21%{transform:matrix3d(.971,0,0,0,0,1.113,0,0,0,0,1,0,0,0,0,1)}13.61%{transform:matrix3d(1.062,0,0,0,0,1.166,0,0,0,0,1,0,0,0,0,1)}14.11%{transform:matrix3d(1.07,0,0,0,0,1.165,0,0,0,0,1,0,0,0,0,1)}17.52%{transform:matrix3d(1.104,0,0,0,0,1.12,0,0,0,0,1,0,0,0,0,1)}18.72%{transform:matrix3d(1.106,0,0,0,0,1.094,0,0,0,0,1,0,0,0,0,1)}21.32%{transform:matrix3d(1.098,0,0,0,0,1.035,0,0,0,0,1,0,0,0,0,1)}24.32%{transform:matrix3d(1.075,0,0,0,0,.98,0,0,0,0,1,0,0,0,0,1)}25.23%{transform:matrix3d(1.067,0,0,0,0,.969,0,0,0,0,1,0,0,0,0,1)}29.03%{transform:matrix3d(1.031,0,0,0,0,.948,0,0,0,0,1,0,0,0,0,1)}29.93%{transform:matrix3d(1.024,0,0,0,0,.949,0,0,0,0,1,0,0,0,0,1)}35.54%{transform:matrix3d(.99,0,0,0,0,.981,0,0,0,0,1,0,0,0,0,1)}36.74%{transform:matrix3d(.986,0,0,0,0,.989,0,0,0,0,1,0,0,0,0,1)}41.04%{transform:matrix3d(.98,0,0,0,0,1.011,0,0,0,0,1,0,0,0,0,1)}44.44%{transform:matrix3d(.983,0,0,0,0,1.016,0,0,0,0,1,0,0,0,0,1)}52.15%{transform:matrix3d(.996,0,0,0,0,1.003,0,0,0,0,1,0,0,0,0,1)}59.86%{transform:matrix3d(1.003,0,0,0,0,.995,0,0,0,0,1,0,0,0,0,1)}63.26%{transform:matrix3d(1.004,0,0,0,0,.996,0,0,0,0,1,0,0,0,0,1)}75.28%{transform:matrix3d(1.001,0,0,0,0,1.002,0,0,0,0,1,0,0,0,0,1)}85.49%{transform:matrix3d(.999,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}90.69%{transform:matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}100%{transform:matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}}@keyframes saladbowl-leaf-shake{0%{transform:translate(2px,1px) rotate(0)}10%{transform:translate(-1px,-2px) rotate(1deg)}20%{transform:translate(-2px,0) rotate(1deg)}30%{transform:translate(0,2px) rotate(0)}40%{transform:translate(1px,-1px) rotate(1deg)}50%{transform:translate(-1px,2px) rotate(1deg)}60%{transform:translate(-2px,1px) rotate(0)}70%{transform:translate(2px,1px) rotate(1deg)}80%{transform:translate(-1px,-1px) rotate(1deg)}90%{transform:translate(2px,2px) rotate(0)}100%{transform:translate(1px,-2px) rotate(1deg)}}@keyframes saladbowl-orange-spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}@keyframes saladbowl-tomato-shake{0%{transform:rotate(10deg)}30%{transform:rotate(0)}60%{transform:rotate(10deg)}90%{transform:rotate(0)}100%{transform:rotate(5deg)}}</style><div role=img class="saladbowl saladict-external enableHover saladbowl-enter-done" style=transform:translate(626px,501px);display:none!important><svg viewBox="0 0 612 612" width=30 height=30><g class=saladbowl-leaf><path fill=#6bbc57 d="M 577.557 184.258 C 560.417 140.85 519.54 59.214 519.54 59.214 L 519.543 59.204 C 519.543 59.204 436.903 97.626 396.441 120.878 C 366.171 138.274 354.981 169.755 352.221 177.621 C 349.001 186.851 339.891 228.811 358.341 268.481 C 382.271 319.921 409.201 374.521 409.201 374.521 L 409.201 374.531 C 409.201 374.531 464.511 348.701 515.291 323.401 C 554.451 303.891 573.591 265.441 576.821 256.221 C 579.571 248.356 590.398 216.746 577.574 184.271 Z"></path><path fill=#bde9b7 d="M 501.052 102.162 L 507.518 104.425 L 426.69 335.38 L 420.224 333.117 Z"></path></g><g class=saladbowl-orange><circle fill=#ffb30d cx=299.756 cy=198.246 r=178.613></circle><circle fill=#fce29c cx=299.756 cy=198.246 r=155.24></circle><path fill=#fcc329 d="M 299.756 189.873 L 341.269 113.475 C 349.169 82.543 324.349 58.588 299.749 57.891 C 275.149 57.201 248.229 82.781 256.489 113.481 L 299.749 189.881 Z M 307.026 194.757 L 393.974 194.757 C 424.928 187.083 434.124 153.681 422.994 131.737 C 411.864 109.795 376.534 98.357 353.5 120.27 L 307.025 194.757 Z M 308.79 203.444 L 354.885 277.168 C 377.925 299.268 410.995 289.438 423.701 268.368 C 436.411 247.298 427.381 211.276 396.591 203.362 L 308.801 203.442 Z M 300.208 206.618 L 259.628 283.516 C 252.098 314.543 277.214 338.193 301.815 338.591 C 326.415 338.991 353.022 313.081 344.392 282.491 L 300.208 206.631 Z M 292.058 203.3 L 205.108 203.415 C 174.163 211.277 165.014 244.54 176.172 266.468 C 187.33 288.396 226.052 300.541 249.056 278.598 L 292.056 203.301 Z M 292.465 194.83 L 246.497 121.024 C 223.494 98.884 190.409 108.658 177.667 129.706 C 164.925 150.753 173.893 186.791 204.669 194.756 L 292.459 194.829 Z"></path></g><g class=saladbowl-tomato><path fill=#a63131 d="M 71.014 337.344 C 147.291 422.594 278.234 429.866 363.482 353.589 L 87.258 44.87 C 2.01 121.15 -5.262 252.092 71.014 337.342 Z"></path><path fill=#bc5757 d="M 101.447 310.115 C 162.685 378.555 267.811 384.393 336.251 323.155 L 114.49 75.31 C 46.047 136.55 40.21 241.674 101.447 310.115 Z"></path><path fill=#f1d4af d="M 186.412 237.54 L 151.659 245.444 C 139.989 251.384 139.339 265.51 145.779 273.27 C 152.219 281.028 167.379 282.39 174.599 271.538 L 186.399 237.54 Z M 242.062 269.832 L 223.366 300.175 C 219.439 312.658 229.066 323.018 239.116 323.85 C 249.168 324.685 260.756 314.815 258.061 302.065 L 242.061 269.832 Z M 160.202 178.317 L 130.357 158.837 C 117.98 154.585 107.375 163.939 106.277 173.965 C 105.183 183.99 114.747 195.833 127.563 193.471 L 160.203 178.321 Z"></path></g><g class=saladbowl-bowl><path fill=#2d97b7 d="M 30.857 311.46 C 30.857 429.87 105.371 530.8 209.867 569.52 L 209.867 589.2 L 400.987 589.2 L 400.987 568.9 C 503.595 530.114 576.887 431.202 578.31 314.907 L 589.196 295.97 L 22.804 295.97 L 30.867 309.998 C 30.865 310.488 30.857 310.971 30.857 311.458 Z"></path><path fill=#fff d="M 540.565 321.42 C 540.585 322.587 540.595 323.755 540.595 324.927 C 540.595 405.941 497.513 476.884 433.015 516.122 L 437.178 523.317 C 504.152 482.64 548.895 409.009 548.895 324.927 C 548.895 323.755 548.885 322.587 548.865 321.419 Z M 399.885 532.68 C 388.298 537.31 376.237 541.002 363.793 543.654 L 363.793 544.45 L 364.971 551.893 C 378.481 549.049 391.551 545.018 404.081 539.935 Z"></path></g></svg></div></div></template></div></div>